<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MyBatisæºç æ·±åº¦è§£æ - å±å±çš„åšå®¢</title>
  <meta name="description" content="{{post.excerpt}}">
  <link rel="stylesheet" href="/static/assets/style.css">
</head>
<body>
  <div class="background-animation"></div>
  <div class="background-animation background-animation-2"></div>
  
  <header class="header">
    <div class="container">
      <nav class="nav">
        <a href="/" class="logo">å±å±çš„åšå®¢</a>
        <div class="nav-links">
          <a href="/" class="nav-link">é¦–é¡µ</a>
          <a href="/static/archives/" class="nav-link">å½’æ¡£</a>
        </div>
        <button class="theme-toggle" aria-label="åˆ‡æ¢ä¸»é¢˜">
          <span class="theme-icon">ğŸŒ™</span>
        </button>
      </nav>
    </div>
  </header>

  <main class="main">
    <div class="container">
      <article class="post">
        <div class="post-header">
          <a href="/" class="back-link">â† è¿”å›é¦–é¡µ</a>
          <h1 class="post-title">MyBatisæºç æ·±åº¦è§£æ</h1>
          <div class="post-meta">
            <span class="post-date">2026å¹´2æœˆ11æ—¥</span>
            
          </div>
        </div>
        
        <div class="post-content">
          <h1>MyBatis æºç æ·±åº¦è§£æ</h1>
<h2 id="ä¸€ã€mybatis-ç®€ä»‹" tabindex="-1">ä¸€ã€MyBatis ç®€ä»‹</h2>
<p>MyBatis æ˜¯ä¸€æ¬¾ä¼˜ç§€çš„æŒä¹…å±‚æ¡†æ¶ï¼Œå®ƒæ”¯æŒå®šåˆ¶åŒ– SQLã€å­˜å‚¨è¿‡ç¨‹ä»¥åŠé«˜çº§æ˜ å°„ã€‚MyBatis é¿å…äº†å‡ ä¹æ‰€æœ‰çš„ JDBC ä»£ç å’Œæ‰‹åŠ¨è®¾ç½®å‚æ•°ä»¥åŠè·å–ç»“æœé›†çš„å·¥ä½œã€‚MyBatis å¯ä»¥ä½¿ç”¨ç®€å•çš„ XML æˆ–æ³¨è§£æ¥é…ç½®å’Œæ˜ å°„åŸç”Ÿä¿¡æ¯ï¼Œå°†æ¥å£å’Œ Java çš„ POJOsï¼ˆPlain Old Java Objectsï¼Œæ™®é€šçš„ Javaå¯¹è±¡ï¼‰æ˜ å°„æˆæ•°æ®åº“ä¸­çš„è®°å½•ã€‚</p>
<h3 id="æ ¸å¿ƒç‰¹ç‚¹" tabindex="-1">æ ¸å¿ƒç‰¹ç‚¹</h3>
<ul>
<li>åŸºäº SQL æ˜ å°„çš„æŒä¹…å±‚æ¡†æ¶</li>
<li>æ”¯æŒåŠ¨æ€ SQL è¯­å¥</li>
<li>æ”¯æŒç¼“å­˜æœºåˆ¶</li>
<li>æä¾›äº†ä¸ Spring çš„æ— ç¼é›†æˆ</li>
<li>çµæ´»çš„æ˜ å°„é…ç½®ï¼ˆXML æˆ–æ³¨è§£ï¼‰</li>
</ul>
<h2 id="äºŒã€mybatis-æ ¸å¿ƒæ¶æ„" tabindex="-1">äºŒã€MyBatis æ ¸å¿ƒæ¶æ„</h2>
<p>MyBatis çš„æ ¸å¿ƒæ¶æ„ç”±ä»¥ä¸‹å‡ ä¸ªå±‚æ¬¡ç»„æˆï¼š</p>
<pre><code class="hljs">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         API Interface Layer             â”‚
â”‚  (SqlSession, Mapper Interface)         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚      Data Processing Layer              â”‚
â”‚  (ParameterHandler, ResultSetHandler)  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚       Statement Handling Layer          â”‚
â”‚      (StatementHandler, Executor)      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚       Core Supporting Layer             â”‚
â”‚  (Configuration, XMLConfigBuilder)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre>
<h3 id="2.1-æ ¸å¿ƒç»„ä»¶" tabindex="-1">2.1 æ ¸å¿ƒç»„ä»¶</h3>
<pre><code class="hljs language-java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Configuration</span> {
    <span class="hljs-keyword">protected</span> Environment environment;
    <span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> safeRowBoundsEnabled;
    <span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> safeResultHandlerEnabled;
    <span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> mapUnderscoreToCamelCase;
    <span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> aggressiveLazyLoading;
    <span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> multipleResultSetsEnabled;
    <span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> useGeneratedKeys;
    <span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> useColumnLabel;
    <span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> cacheEnabled;
    <span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> callSettersOnNulls;
    
    <span class="hljs-keyword">protected</span> Map&lt;String, MappedStatement&gt; mappedStatements = <span class="hljs-keyword">new</span> <span class="hljs-title class_">StrictMap</span>&lt;MappedStatement&gt;(<span class="hljs-string">&quot;Mapped Statements collection&quot;</span>);
    <span class="hljs-keyword">protected</span> Map&lt;String, Cache&gt; caches = <span class="hljs-keyword">new</span> <span class="hljs-title class_">StrictMap</span>&lt;Cache&gt;(<span class="hljs-string">&quot;Caches collection&quot;</span>);
    <span class="hljs-keyword">protected</span> Map&lt;String, ResultMap&gt; resultMaps = <span class="hljs-keyword">new</span> <span class="hljs-title class_">StrictMap</span>&lt;ResultMap&gt;(<span class="hljs-string">&quot;Result Maps collection&quot;</span>);
    <span class="hljs-keyword">protected</span> Map&lt;String, ParameterMap&gt; parameterMaps = <span class="hljs-keyword">new</span> <span class="hljs-title class_">StrictMap</span>&lt;ParameterMap&gt;(<span class="hljs-string">&quot;Parameter Maps collection&quot;</span>);
    <span class="hljs-keyword">protected</span> Map&lt;String, KeyGenerator&gt; keyGenerators = <span class="hljs-keyword">new</span> <span class="hljs-title class_">StrictMap</span>&lt;KeyGenerator&gt;(<span class="hljs-string">&quot;Key Generators collection&quot;</span>);
    
    <span class="hljs-keyword">protected</span> <span class="hljs-type">TypeHandlerRegistry</span> <span class="hljs-variable">typeHandlerRegistry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeHandlerRegistry</span>();
    <span class="hljs-keyword">protected</span> <span class="hljs-type">TypeAliasRegistry</span> <span class="hljs-variable">typeAliasRegistry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeAliasRegistry</span>();
    <span class="hljs-keyword">protected</span> <span class="hljs-type">ObjectFactory</span> <span class="hljs-variable">objectFactory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultObjectFactory</span>();
    <span class="hljs-keyword">protected</span> <span class="hljs-type">ObjectWrapperFactory</span> <span class="hljs-variable">objectWrapperFactory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultObjectWrapperFactory</span>();
    <span class="hljs-keyword">protected</span> <span class="hljs-type">ReflectorFactory</span> <span class="hljs-variable">reflectorFactory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultReflectorFactory</span>();
}
</code></pre>
<h2 id="ä¸‰ã€mybatis-åˆå§‹åŒ–æµç¨‹" tabindex="-1">ä¸‰ã€MyBatis åˆå§‹åŒ–æµç¨‹</h2>
<h3 id="3.1-æ•´ä½“åˆå§‹åŒ–æµç¨‹å›¾" tabindex="-1">3.1 æ•´ä½“åˆå§‹åŒ–æµç¨‹å›¾</h3>
<pre><code class="hljs">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åŠ è½½é…ç½®æ–‡ä»¶  â”‚
â”‚ mybatis.<span class="hljs-keyword">xml</span> <span class="hljs-title">â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   SqlSessionFactory</span>  â”‚
â”‚    .Builder.build()  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ XMLConfigBuilder    â”‚
â”‚   è§£æé…ç½®æ–‡ä»¶       â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ XMLMapperBuilder    â”‚
â”‚   è§£ææ˜ å°„æ–‡ä»¶       â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Configuration     â”‚
â”‚   (æ ¸å¿ƒé…ç½®å¯¹è±¡)     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  DefaultSqlSession  â”‚
â”‚   Factory          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre>
<h3 id="3.2-åˆå§‹åŒ–æºç åˆ†æ" tabindex="-1">3.2 åˆå§‹åŒ–æºç åˆ†æ</h3>
<h4 id="3.2.1-sqlsessionfactory-æ„å»º" tabindex="-1">3.2.1 SqlSessionFactory æ„å»º</h4>
<pre><code class="hljs language-java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SqlSessionFactoryBuilder</span> {
    
    <span class="hljs-keyword">public</span> SqlSessionFactory <span class="hljs-title function_">build</span><span class="hljs-params">(InputStream inputStream)</span> {
        <span class="hljs-keyword">return</span> build(inputStream, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);
    }
    
    <span class="hljs-keyword">public</span> SqlSessionFactory <span class="hljs-title function_">build</span><span class="hljs-params">(InputStream inputStream, String environment, Properties properties)</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">XMLConfigBuilder</span> <span class="hljs-variable">parser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLConfigBuilder</span>(inputStream, environment, properties);
            <span class="hljs-keyword">return</span> build(parser.parse());
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">throw</span> ExceptionFactory.wrapException(<span class="hljs-string">&quot;Error building SqlSession.&quot;</span>, e);
        } <span class="hljs-keyword">finally</span> {
            ErrorContext.instance().reset();
            <span class="hljs-keyword">try</span> {
                inputStream.close();
            } <span class="hljs-keyword">catch</span> (IOException e) {
                <span class="hljs-comment">// ignore</span>
            }
        }
    }
    
    <span class="hljs-keyword">public</span> SqlSessionFactory <span class="hljs-title function_">build</span><span class="hljs-params">(Configuration config)</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultSqlSessionFactory</span>(config);
    }
}
</code></pre>
<h4 id="3.2.2-xmlconfigbuilder-è§£æé…ç½®" tabindex="-1">3.2.2 XMLConfigBuilder è§£æé…ç½®</h4>
<pre><code class="hljs language-java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">XMLConfigBuilder</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseBuilder</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> parsed;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> XPathParser parser;
    <span class="hljs-keyword">private</span> String environment;
    
    <span class="hljs-keyword">public</span> Configuration <span class="hljs-title function_">parse</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">if</span> (parsed) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderException</span>(<span class="hljs-string">&quot;Each XMLConfigBuilder can only be used once.&quot;</span>);
        }
        parsed = <span class="hljs-literal">true</span>;
        parseConfiguration(parser.evalNode(<span class="hljs-string">&quot;/configuration&quot;</span>));
        <span class="hljs-keyword">return</span> configuration;
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">parseConfiguration</span><span class="hljs-params">(XNode root)</span> {
        <span class="hljs-keyword">try</span> {
            propertiesElement(root.evalNode(<span class="hljs-string">&quot;properties&quot;</span>));
            settingsAsProperties(root.evalNode(<span class="hljs-string">&quot;settings&quot;</span>));
            typeAliasesElement(root.evalNode(<span class="hljs-string">&quot;typeAliases&quot;</span>));
            pluginElement(root.evalNode(<span class="hljs-string">&quot;plugins&quot;</span>));
            objectFactoryElement(root.evalNode(<span class="hljs-string">&quot;objectFactory&quot;</span>));
            objectWrapperFactoryElement(root.evalNode(<span class="hljs-string">&quot;objectWrapperFactory&quot;</span>));
            reflectorFactoryElement(root.evalNode(<span class="hljs-string">&quot;reflectorFactory&quot;</span>));
            settingsElement(settings);
            environmentsElement(root.evalNode(<span class="hljs-string">&quot;environments&quot;</span>));
            databaseIdProviderElement(root.evalNode(<span class="hljs-string">&quot;databaseIdProvider&quot;</span>));
            typeHandlerElement(root.evalNode(<span class="hljs-string">&quot;typeHandlers&quot;</span>));
            mapperElement(root.evalNode(<span class="hljs-string">&quot;mappers&quot;</span>));
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderException</span>(<span class="hljs-string">&quot;Error parsing SQL Mapper Configuration. Cause: &quot;</span> + e, e);
        }
    }
}
</code></pre>
<h4 id="3.2.3-mapper-è§£æ" tabindex="-1">3.2.3 Mapper è§£æ</h4>
<pre><code class="hljs language-java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">XMLMapperBuilder</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseBuilder</span> {
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">parse</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">if</span> (!configuration.isResourceLoaded(resource)) {
            configurationElement(parser.evalNode(<span class="hljs-string">&quot;/mapper&quot;</span>));
            configuration.addLoadedResource(resource);
            bindMapperForNamespace();
        }
        parsePendingResultMaps();
        parsePendingCacheRefs();
        parsePendingStatements();
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configurationElement</span><span class="hljs-params">(XNode context)</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">String</span> <span class="hljs-variable">namespace</span> <span class="hljs-operator">=</span> context.getStringAttribute(<span class="hljs-string">&quot;namespace&quot;</span>);
            <span class="hljs-keyword">if</span> (namespace == <span class="hljs-literal">null</span> || namespace.isEmpty()) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderException</span>(<span class="hljs-string">&quot;Mapper&#x27;s namespace cannot be empty&quot;</span>);
            }
            builderAssistant.setCurrentNamespace(namespace);
            cacheRefElement(context.evalNode(<span class="hljs-string">&quot;cache-ref&quot;</span>));
            cacheElement(context.evalNode(<span class="hljs-string">&quot;cache&quot;</span>));
            parameterMapElement(context.evalNodes(<span class="hljs-string">&quot;/mapper/parameterMap&quot;</span>));
            resultMapElements(context.evalNodes(<span class="hljs-string">&quot;/mapper/resultMap&quot;</span>));
            sqlElement(context.evalNodes(<span class="hljs-string">&quot;/mapper/sql&quot;</span>));
            buildStatementFromContext(context.evalNodes(<span class="hljs-string">&quot;select|insert|update|delete&quot;</span>));
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderException</span>(<span class="hljs-string">&quot;Error parsing Mapper XML. Cause: &quot;</span> + e, e);
        }
    }
}
</code></pre>
<h2 id="å››ã€sql-æ‰§è¡Œæ ¸å¿ƒæµç¨‹" tabindex="-1">å››ã€SQL æ‰§è¡Œæ ¸å¿ƒæµç¨‹</h2>
<h3 id="4.1-sql-æ‰§è¡Œå®Œæ•´æµç¨‹å›¾" tabindex="-1">4.1 SQL æ‰§è¡Œå®Œæ•´æµç¨‹å›¾</h3>
<pre><code class="hljs">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è·å– Mapper  â”‚
â”‚   æ¥å£å®ä¾‹    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MapperProxy      â”‚
â”‚  (åŠ¨æ€ä»£ç†)       â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MapperMethod    â”‚
â”‚  (æ–¹æ³•å°è£…)       â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SqlSession      â”‚
â”‚  (ä¼šè¯ç®¡ç†)       â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Executor        â”‚
â”‚  (æ‰§è¡Œå™¨)         â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ StatementHandler â”‚
â”‚  (è¯­å¥å¤„ç†)       â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ParameterHandlerâ”‚
â”‚  (å‚æ•°è®¾ç½®)       â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ResultSet       â”‚
â”‚  Handler         â”‚
â”‚  (ç»“æœé›†å¤„ç†)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre>
<h3 id="4.2-mapper-åŠ¨æ€ä»£ç†æœºåˆ¶" tabindex="-1">4.2 Mapper åŠ¨æ€ä»£ç†æœºåˆ¶</h3>
<pre><code class="hljs language-java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MapperProxy</span>&lt;T&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InvocationHandler</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> SqlSession sqlSession;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Class&lt;T&gt; mapperInterface;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;Method, MapperMethod&gt; methodCache;
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] args)</span> <span class="hljs-keyword">throws</span> Throwable {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">if</span> (Object.class.equals(method.getDeclaringClass())) {
                <span class="hljs-keyword">return</span> method.invoke(<span class="hljs-built_in">this</span>, args);
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (isDefaultMethod(method)) {
                <span class="hljs-keyword">return</span> invokeDefaultMethod(proxy, method, args);
            }
        } <span class="hljs-keyword">catch</span> (Throwable t) {
            <span class="hljs-keyword">throw</span> ExceptionUtil.unwrapThrowable(t);
        }
        <span class="hljs-keyword">final</span> <span class="hljs-type">MapperMethod</span> <span class="hljs-variable">mapperMethod</span> <span class="hljs-operator">=</span> cachedMapperMethod(method);
        <span class="hljs-keyword">return</span> mapperMethod.execute(sqlSession, args);
    }
    
    <span class="hljs-keyword">private</span> MapperMethod <span class="hljs-title function_">cachedMapperMethod</span><span class="hljs-params">(Method method)</span> {
        <span class="hljs-type">MapperMethod</span> <span class="hljs-variable">mapperMethod</span> <span class="hljs-operator">=</span> methodCache.get(method);
        <span class="hljs-keyword">if</span> (mapperMethod == <span class="hljs-literal">null</span>) {
            mapperMethod = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MapperMethod</span>(mapperInterface, method, sqlSession.getConfiguration());
            methodCache.put(method, mapperMethod);
        }
        <span class="hljs-keyword">return</span> mapperMethod;
    }
}
</code></pre>
<h3 id="4.3-mappermethod-æ‰§è¡Œé€»è¾‘" tabindex="-1">4.3 MapperMethod æ‰§è¡Œé€»è¾‘</h3>
<pre><code class="hljs language-java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MapperMethod</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> SqlCommand command;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> MethodSignature method;
    
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">execute</span><span class="hljs-params">(SqlSession sqlSession, Object[] args)</span> {
        Object result;
        <span class="hljs-keyword">switch</span> (command.getType()) {
            <span class="hljs-keyword">case</span> INSERT: {
                <span class="hljs-type">Object</span> <span class="hljs-variable">param</span> <span class="hljs-operator">=</span> method.convertArgsToSqlCommandParam(args);
                result = rowCountResult(sqlSession.insert(command.getName(), param));
                <span class="hljs-keyword">break</span>;
            }
            <span class="hljs-keyword">case</span> UPDATE: {
                <span class="hljs-type">Object</span> <span class="hljs-variable">param</span> <span class="hljs-operator">=</span> method.convertArgsToSqlCommandParam(args);
                result = rowCountResult(sqlSession.update(command.getName(), param));
                <span class="hljs-keyword">break</span>;
            }
            <span class="hljs-keyword">case</span> DELETE: {
                <span class="hljs-type">Object</span> <span class="hljs-variable">param</span> <span class="hljs-operator">=</span> method.convertArgsToSqlCommandParam(args);
                result = rowCountResult(sqlSession.delete(command.getName(), param));
                <span class="hljs-keyword">break</span>;
            }
            <span class="hljs-keyword">case</span> SELECT:
                <span class="hljs-keyword">if</span> (method.returnsVoid() &amp;&amp; method.hasResultHandler()) {
                    executeWithResultHandler(sqlSession, args);
                    result = <span class="hljs-literal">null</span>;
                } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (method.returnsMany()) {
                    result = executeForMany(sqlSession, args);
                } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (method.returnsMap()) {
                    result = executeForMap(sqlSession, args);
                } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (method.returnsCursor()) {
                    result = executeForCursor(sqlSession, args);
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-type">Object</span> <span class="hljs-variable">param</span> <span class="hljs-operator">=</span> method.convertArgsToSqlCommandParam(args);
                    result = sqlSession.selectOne(command.getName(), param);
                }
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">case</span> FLUSH:
                result = sqlSession.flushStatements();
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">default</span>:
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BindingException</span>(<span class="hljs-string">&quot;Unknown execution method for: &quot;</span> + command.getName());
        }
        <span class="hljs-keyword">if</span> (result == <span class="hljs-literal">null</span> &amp;&amp; method.getReturnType().isPrimitive() &amp;&amp; !method.returnsVoid()) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BindingException</span>(<span class="hljs-string">&quot;Mapper method &#x27;&quot;</span> + command.getName() 
                + <span class="hljs-string">&quot; attempted to return null from a method with a primitive return type (&quot;</span> + method.getReturnType() + <span class="hljs-string">&quot;).&quot;</span>);
        }
        <span class="hljs-keyword">return</span> result;
    }
}
</code></pre>
<h3 id="4.4-sqlsession-æ‰§è¡Œæµç¨‹" tabindex="-1">4.4 SqlSession æ‰§è¡Œæµç¨‹</h3>
<pre><code class="hljs language-java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DefaultSqlSession</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">SqlSession</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Configuration configuration;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Executor executor;
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> &lt;E&gt; List&lt;E&gt; <span class="hljs-title function_">selectList</span><span class="hljs-params">(String statement, Object parameter, RowBounds rowBounds)</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">MappedStatement</span> <span class="hljs-variable">ms</span> <span class="hljs-operator">=</span> configuration.getMappedStatement(statement);
            <span class="hljs-keyword">return</span> executor.query(ms, wrapCollection(parameter), rowBounds, Executor.NO_RESULT_HANDLER);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">throw</span> ExceptionFactory.wrapException(<span class="hljs-string">&quot;Error querying database. Cause: &quot;</span> + e, e);
        } <span class="hljs-keyword">finally</span> {
            ErrorContext.instance().reset();
        }
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> &lt;T&gt; T <span class="hljs-title function_">selectOne</span><span class="hljs-params">(String statement, Object parameter)</span> {
        List&lt;T&gt; list = <span class="hljs-built_in">this</span>.&lt;T&gt;selectList(statement, parameter);
        <span class="hljs-keyword">if</span> (list.size() == <span class="hljs-number">1</span>) {
            <span class="hljs-keyword">return</span> list.get(<span class="hljs-number">0</span>);
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (list.size() &gt; <span class="hljs-number">1</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TooManyResultsException</span>(<span class="hljs-string">&quot;Expected one result (or null) to be returned by selectOne(), but found: &quot;</span> + list.size());
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }
    }
}
</code></pre>
<h2 id="äº”ã€executor-æ‰§è¡Œå™¨" tabindex="-1">äº”ã€Executor æ‰§è¡Œå™¨</h2>
<h3 id="5.1-executor-ç»§æ‰¿ä½“ç³»" tabindex="-1">5.1 Executor ç»§æ‰¿ä½“ç³»</h3>
<pre><code class="hljs">        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   Executor   â”‚
        â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                â”‚
â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ <span class="hljs-keyword">BaseExecutorâ”‚ </span> â”‚ CachingExecutorâ”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
  â”Œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚    â”‚        â”‚        â”‚
â”Œâ”€â–¼â”€â”â”Œâ”€â–¼â”€â”€â”€â”â”Œâ”€â”€â–¼â”€â”€â”â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”
â”‚Simpleâ”‚Reuseâ”‚<span class="hljs-keyword">Batchâ”‚Closedâ”‚
</span>â”‚Executorâ”‚Executorâ”‚Executorâ”‚Executorâ”‚
â””â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre>
<h3 id="5.2-baseexecutor-æ ¸å¿ƒå®ç°" tabindex="-1">5.2 BaseExecutor æ ¸å¿ƒå®ç°</h3>
<pre><code class="hljs language-java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BaseExecutor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Executor</span> {
    
    <span class="hljs-keyword">protected</span> Transaction transaction;
    <span class="hljs-keyword">protected</span> Wrapper wrapper;
    <span class="hljs-keyword">protected</span> ConcurrentLinkedQueue&lt;DeferredLoad&gt; deferredLoads;
    <span class="hljs-keyword">protected</span> PerpetualCache localCache;
    <span class="hljs-keyword">protected</span> PerpetualCache localOutputParameterCache;
    <span class="hljs-keyword">protected</span> Configuration configuration;
    
    <span class="hljs-keyword">protected</span> List&lt;BatchResult&gt; batchResults = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
    <span class="hljs-keyword">protected</span> <span class="hljs-type">int</span> <span class="hljs-variable">queryStack</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> &lt;E&gt; List&lt;E&gt; <span class="hljs-title function_">query</span><span class="hljs-params">(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler)</span> <span class="hljs-keyword">throws</span> SQLException {
        <span class="hljs-type">BoundSql</span> <span class="hljs-variable">boundSql</span> <span class="hljs-operator">=</span> ms.getBoundSql(parameter);
        <span class="hljs-type">CacheKey</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> createCacheKey(ms, parameter, rowBounds, boundSql);
        <span class="hljs-keyword">return</span> query(ms, parameter, rowBounds, resultHandler, key, boundSql);
    }
    
    <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> &lt;E&gt; List&lt;E&gt; <span class="hljs-title function_">query</span><span class="hljs-params">(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, CacheKey key, BoundSql boundSql)</span> <span class="hljs-keyword">throws</span> SQLException {
        ErrorContext.instance().resource(ms.getResource()).activity(<span class="hljs-string">&quot;executing a query&quot;</span>).object(ms.getId());
        <span class="hljs-keyword">if</span> (closed) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutorException</span>(<span class="hljs-string">&quot;Executor was closed.&quot;</span>);
        }
        <span class="hljs-keyword">if</span> (queryStack == <span class="hljs-number">0</span> &amp;&amp; ms.isFlushCacheRequired()) {
            clearLocalCache();
        }
        List&lt;E&gt; list;
        <span class="hljs-keyword">try</span> {
            queryStack++;
            list = resultHandler == <span class="hljs-literal">null</span> ? (List&lt;E&gt;) localCache.getObject(key) : <span class="hljs-literal">null</span>;
            <span class="hljs-keyword">if</span> (list != <span class="hljs-literal">null</span>) {
                handleLocallyCachedOutputParameters(ms, key, parameter, boundSql);
            } <span class="hljs-keyword">else</span> {
                list = queryFromDatabase(ms, parameter, rowBounds, resultHandler, key, boundSql);
            }
        } <span class="hljs-keyword">finally</span> {
            queryStack--;
        }
        <span class="hljs-keyword">if</span> (queryStack == <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">for</span> (DeferredLoad deferredLoad : deferredLoads) {
                deferredLoad.load();
            }
            deferredLoads.clear();
            <span class="hljs-keyword">if</span> (configuration.getLocalCacheScope() == LocalCacheScope.STATEMENT) {
                clearLocalCache();
            }
        }
        <span class="hljs-keyword">return</span> list;
    }
    
    <span class="hljs-keyword">private</span> &lt;E&gt; List&lt;E&gt; <span class="hljs-title function_">queryFromDatabase</span><span class="hljs-params">(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, CacheKey key, BoundSql boundSql)</span> <span class="hljs-keyword">throws</span> SQLException {
        List&lt;E&gt; list;
        localCache.putObject(key, EXECUTION_PLACEHOLDER);
        <span class="hljs-keyword">try</span> {
            list = doQuery(ms, parameter, rowBounds, resultHandler, boundSql);
        } <span class="hljs-keyword">finally</span> {
            localCache.removeObject(key);
        }
        localCache.putObject(key, list);
        <span class="hljs-keyword">if</span> (ms.getStatementType() == StatementType.CALLABLE) {
            localOutputParameterCache.putObject(key, parameter);
        }
        <span class="hljs-keyword">return</span> list;
    }
    
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> &lt;E&gt; List&lt;E&gt; <span class="hljs-title function_">doQuery</span><span class="hljs-params">(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, BoundSql boundSql)</span> <span class="hljs-keyword">throws</span> SQLException;
}
</code></pre>
<h3 id="5.3-simpleexecutor-å®ç°" tabindex="-1">5.3 SimpleExecutor å®ç°</h3>
<pre><code class="hljs language-java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SimpleExecutor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseExecutor</span> {
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> &lt;E&gt; List&lt;E&gt; <span class="hljs-title function_">doQuery</span><span class="hljs-params">(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, BoundSql boundSql)</span> <span class="hljs-keyword">throws</span> SQLException {
        <span class="hljs-type">Statement</span> <span class="hljs-variable">stmt</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">Configuration</span> <span class="hljs-variable">configuration</span> <span class="hljs-operator">=</span> ms.getConfiguration();
            <span class="hljs-type">StatementHandler</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> configuration.newStatementHandler(wrapper, ms, parameter, rowBounds, resultHandler, boundSql);
            stmt = prepareStatement(handler, ms.getStatementLog());
            <span class="hljs-keyword">return</span> handler.&lt;E&gt;query(stmt, resultHandler);
        } <span class="hljs-keyword">finally</span> {
            closeStatement(stmt);
        }
    }
    
    <span class="hljs-keyword">private</span> Statement <span class="hljs-title function_">prepareStatement</span><span class="hljs-params">(StatementHandler handler, Log statementLog)</span> <span class="hljs-keyword">throws</span> SQLException {
        Statement stmt;
        <span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> getConnection(statementLog);
        stmt = handler.prepare(connection, transaction.getTimeout());
        handler.parameterize(stmt);
        <span class="hljs-keyword">return</span> stmt;
    }
}
</code></pre>
<h2 id="å…­ã€statementhandler-è¯­å¥å¤„ç†å™¨" tabindex="-1">å…­ã€StatementHandler è¯­å¥å¤„ç†å™¨</h2>
<h3 id="6.1-statementhandler-ç»§æ‰¿ä½“ç³»" tabindex="-1">6.1 StatementHandler ç»§æ‰¿ä½“ç³»</h3>
<pre><code class="hljs">         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ StatementHandlerâ”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚             â”‚             â”‚
â”Œâ”€â”€â”€â–¼â”€â”€â”€â”   â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”
â”‚Base   â”‚   â”‚Callableâ”‚   â”‚Routing â”‚
â”‚<span class="hljs-keyword">Statement</span>â”‚ â”‚<span class="hljs-keyword">Handler</span> â”‚ â”‚<span class="hljs-keyword">Handler</span> â”‚
â”‚<span class="hljs-keyword">Handler</span>â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”¬â”€â”€â”€â”˜
    â”‚
â”Œâ”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   â”‚            â”‚          â”‚
â”Œâ–¼â”€â”â”Œâ–¼â”€â”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
â”‚Simpleâ”‚<span class="hljs-keyword">Prepare</span>â”‚Callableâ”‚Callableâ”‚
â”‚<span class="hljs-keyword">Statement</span>â”‚dStatementâ”‚<span class="hljs-keyword">Handler</span> â”‚<span class="hljs-keyword">Handler</span> â”‚
â”‚<span class="hljs-keyword">Handler</span>â”‚<span class="hljs-keyword">Handler</span>â”‚<span class="hljs-keyword">Handler</span> â”‚<span class="hljs-keyword">Handler</span> â”‚
â””â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre>
<h3 id="6.2-preparedstatementhandler-å®ç°" tabindex="-1">6.2 PreparedStatementHandler å®ç°</h3>
<pre><code class="hljs language-java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PreparedStatementHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseStatementHandler</span> {
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> &lt;E&gt; List&lt;E&gt; <span class="hljs-title function_">query</span><span class="hljs-params">(Statement statement, ResultHandler resultHandler)</span> <span class="hljs-keyword">throws</span> SQLException {
        <span class="hljs-type">PreparedStatement</span> <span class="hljs-variable">ps</span> <span class="hljs-operator">=</span> (PreparedStatement) statement;
        ps.execute();
        <span class="hljs-keyword">return</span> resultSetHandler.&lt;E&gt;handleResultSets(ps);
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> Statement <span class="hljs-title function_">instantiateStatement</span><span class="hljs-params">(Connection connection)</span> <span class="hljs-keyword">throws</span> SQLException {
        <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> boundSql.getSql();
        <span class="hljs-keyword">if</span> (mappedStatement.getKeyGenerator() <span class="hljs-keyword">instanceof</span> Jdbc3KeyGenerator) {
            String[] keyColumnNames = mappedStatement.getKeyColumns();
            <span class="hljs-keyword">if</span> (keyColumnNames == <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">return</span> connection.prepareStatement(sql, PreparedStatement.RETURN_GENERATED_KEYS);
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">return</span> connection.prepareStatement(sql, keyColumnNames);
            }
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (mappedStatement.getResultSetType() != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> connection.prepareStatement(sql, mappedStatement.getResultSetType().getValue(), ResultSet.CONCUR_READ_ONLY);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">return</span> connection.prepareStatement(sql);
        }
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">parameterize</span><span class="hljs-params">(Statement statement)</span> <span class="hljs-keyword">throws</span> SQLException {
        parameterHandler.setParameters((PreparedStatement) statement);
    }
}
</code></pre>
<h3 id="6.3-parameterhandler-å‚æ•°å¤„ç†å™¨" tabindex="-1">6.3 ParameterHandler å‚æ•°å¤„ç†å™¨</h3>
<pre><code class="hljs language-java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ParameterHandler</span> {
    Object <span class="hljs-title function_">getParameterObject</span><span class="hljs-params">()</span>;
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">setParameters</span><span class="hljs-params">(PreparedStatement ps)</span> <span class="hljs-keyword">throws</span> SQLException;
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DefaultParameterHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ParameterHandler</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> TypeHandlerRegistry typeHandlerRegistry;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> MappedStatement mappedStatement;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Object parameterObject;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> BoundSql boundSql;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Configuration configuration;
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setParameters</span><span class="hljs-params">(PreparedStatement ps)</span> {
        ErrorContext.instance().activity(<span class="hljs-string">&quot;setting parameters&quot;</span>).object(mappedStatement.getParameterMap().getId());
        List&lt;ParameterMapping&gt; parameterMappings = boundSql.getParameterMappings();
        <span class="hljs-keyword">if</span> (parameterMappings != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; parameterMappings.size(); i++) {
                <span class="hljs-type">ParameterMapping</span> <span class="hljs-variable">parameterMapping</span> <span class="hljs-operator">=</span> parameterMappings.get(i);
                <span class="hljs-keyword">if</span> (parameterMapping.getMode() != ParameterMode.OUT) {
                    Object value;
                    <span class="hljs-type">String</span> <span class="hljs-variable">propertyName</span> <span class="hljs-operator">=</span> parameterMapping.getProperty();
                    <span class="hljs-keyword">if</span> (boundSql.hasAdditionalParameter(propertyName)) {
                        value = boundSql.getAdditionalParameter(propertyName);
                    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (parameterObject == <span class="hljs-literal">null</span>) {
                        value = <span class="hljs-literal">null</span>;
                    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (typeHandlerRegistry.hasTypeHandler(parameterObject.getClass())) {
                        value = parameterObject;
                    } <span class="hljs-keyword">else</span> {
                        <span class="hljs-type">MetaObject</span> <span class="hljs-variable">metaObject</span> <span class="hljs-operator">=</span> configuration.newMetaObject(parameterObject);
                        value = metaObject.getValue(propertyName);
                    }
                    <span class="hljs-type">TypeHandler</span> <span class="hljs-variable">typeHandler</span> <span class="hljs-operator">=</span> parameterMapping.getTypeHandler();
                    <span class="hljs-type">JdbcType</span> <span class="hljs-variable">jdbcType</span> <span class="hljs-operator">=</span> parameterMapping.getJdbcType();
                    <span class="hljs-keyword">if</span> (value == <span class="hljs-literal">null</span> &amp;&amp; jdbcType == <span class="hljs-literal">null</span>) {
                        jdbcType = configuration.getJdbcTypeForNull();
                    }
                    <span class="hljs-keyword">try</span> {
                        typeHandler.setParameter(ps, i + <span class="hljs-number">1</span>, value, jdbcType);
                    } <span class="hljs-keyword">catch</span> (TypeException e) {
                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeException</span>(<span class="hljs-string">&quot;Could not set parameters for mapping: &quot;</span> + parameterMapping + <span class="hljs-string">&quot;. Cause: &quot;</span> + e, e);
                    } <span class="hljs-keyword">catch</span> (SQLException e) {
                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeException</span>(<span class="hljs-string">&quot;Could not set parameters for mapping: &quot;</span> + parameterMapping + <span class="hljs-string">&quot;. Cause: &quot;</span> + e, e);
                    }
                }
            }
        }
    }
}
</code></pre>
<h3 id="6.4-resultsethandler-ç»“æœé›†å¤„ç†å™¨" tabindex="-1">6.4 ResultSetHandler ç»“æœé›†å¤„ç†å™¨</h3>
<pre><code class="hljs language-java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ResultSetHandler</span> {
    &lt;E&gt; List&lt;E&gt; <span class="hljs-title function_">handleResultSets</span><span class="hljs-params">(Statement stmt)</span> <span class="hljs-keyword">throws</span> SQLException;
    &lt;E&gt; Cursor&lt;E&gt; <span class="hljs-title function_">handleCursorResultSets</span><span class="hljs-params">(Statement stmt)</span> <span class="hljs-keyword">throws</span> SQLException;
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleOutputParameters</span><span class="hljs-params">(CallableStatement cs)</span> <span class="hljs-keyword">throws</span> SQLException;
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DefaultResultSetHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ResultSetHandler</span> {
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> List&lt;Object&gt; <span class="hljs-title function_">handleResultSets</span><span class="hljs-params">(Statement stmt)</span> <span class="hljs-keyword">throws</span> SQLException {
        ErrorContext.instance().activity(<span class="hljs-string">&quot;handling results&quot;</span>).object(mappedStatement.getId());
        
        <span class="hljs-keyword">final</span> List&lt;Object&gt; multipleResults = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        <span class="hljs-type">int</span> <span class="hljs-variable">resultSetCount</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        <span class="hljs-type">ResultSetWrapper</span> <span class="hljs-variable">rsw</span> <span class="hljs-operator">=</span> getFirstResultSet(stmt);
        
        List&lt;ResultMap&gt; resultMaps = mappedStatement.getResultMaps();
        <span class="hljs-type">int</span> <span class="hljs-variable">resultMapCount</span> <span class="hljs-operator">=</span> resultMaps.size();
        validateResultMapsCount(rsw, resultMapCount);
        
        <span class="hljs-keyword">while</span> (rsw != <span class="hljs-literal">null</span> &amp;&amp; resultMapCount &gt; resultSetCount) {
            <span class="hljs-type">ResultMap</span> <span class="hljs-variable">resultMap</span> <span class="hljs-operator">=</span> resultMaps.get(resultSetCount);
            handleResultSet(rsw, resultMap, multipleResults, <span class="hljs-literal">null</span>);
            rsw = getNextResultSet(stmt);
            cleanUpAfterHandlingResultSet();
            resultSetCount++;
        }
        
        String[] resultSets = mappedStatement.getResultSets();
        <span class="hljs-keyword">if</span> (resultSets != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">while</span> (rsw != <span class="hljs-literal">null</span> &amp;&amp; resultSetCount &lt; resultSets.length) {
                <span class="hljs-type">ResultMapping</span> <span class="hljs-variable">parentMapping</span> <span class="hljs-operator">=</span> nextResultMaps.get(resultSets[resultSetCount]);
                <span class="hljs-keyword">if</span> (parentMapping != <span class="hljs-literal">null</span>) {
                    <span class="hljs-type">String</span> <span class="hljs-variable">nestedResultMapId</span> <span class="hljs-operator">=</span> parentMapping.getNestedResultMapId();
                    <span class="hljs-type">ResultMap</span> <span class="hljs-variable">resultMap</span> <span class="hljs-operator">=</span> configuration.getResultMap(nestedResultMapId);
                    handleResultSet(rsw, resultMap, <span class="hljs-literal">null</span>, parentMapping);
                }
                rsw = getNextResultSet(stmt);
                cleanUpAfterHandlingResultSet();
                resultSetCount++;
            }
        }
        
        <span class="hljs-keyword">return</span> collapseSingleResultList(multipleResults);
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleResultSet</span><span class="hljs-params">(ResultSetWrapper rsw, ResultMap resultMap, List&lt;Object&gt; multipleResults, ResultMapping parentMapping)</span> <span class="hljs-keyword">throws</span> SQLException {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">if</span> (parentMapping != <span class="hljs-literal">null</span>) {
                handleRowValuesForNestedResultMap(rsw, resultMap, <span class="hljs-literal">null</span>, parentMapping);
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">if</span> (resultHandler == <span class="hljs-literal">null</span>) {
                    handleRowValuesForDefaultResultMap(rsw, resultMap, multipleResults, <span class="hljs-literal">null</span>);
                } <span class="hljs-keyword">else</span> {
                    handleRowValuesForSimpleResultMap(rsw, resultMap, resultHandler, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);
                }
            }
        } <span class="hljs-keyword">finally</span> {
            closeResultSet(rsw.getResultSet());
        }
    }
}
</code></pre>
<h2 id="ä¸ƒã€ç¼“å­˜æœºåˆ¶" tabindex="-1">ä¸ƒã€ç¼“å­˜æœºåˆ¶</h2>
<h3 id="7.1-mybatis-ç¼“å­˜ç»“æ„" tabindex="-1">7.1 MyBatis ç¼“å­˜ç»“æ„</h3>
<pre><code class="hljs">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      <span class="hljs-keyword">Cache</span> æ¥å£                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                 â”‚
â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
â”‚Perpetualâ”‚    â”‚  Blocking â”‚
â”‚<span class="hljs-keyword">Cache</span>    â”‚    â”‚<span class="hljs-keyword">Cache</span>      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â”‚
â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    è£…é¥°å™¨æ¨¡å¼                â”‚
â”‚  LruCache / FifoCache     â”‚
â”‚  SoftCache / WeakCache     â”‚
â”‚  LoggingCache / SyncCache  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre>
<h3 id="7.2-ç¼“å­˜å®ç°" tabindex="-1">7.2 ç¼“å­˜å®ç°</h3>
<pre><code class="hljs language-java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PerpetualCache</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Cache</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String id;
    <span class="hljs-keyword">private</span> Map&lt;Object, Object&gt; cache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">PerpetualCache</span><span class="hljs-params">(String id)</span> {
        <span class="hljs-built_in">this</span>.id = id;
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getId</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> id;
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getSize</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> cache.size();
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">putObject</span><span class="hljs-params">(Object key, Object value)</span> {
        cache.put(key, value);
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getObject</span><span class="hljs-params">(Object key)</span> {
        <span class="hljs-keyword">return</span> cache.get(key);
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">removeObject</span><span class="hljs-params">(Object key)</span> {
        <span class="hljs-keyword">return</span> cache.remove(key);
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">clear</span><span class="hljs-params">()</span> {
        cache.clear();
    }
}
</code></pre>
<h2 id="å…«ã€åŠ¨æ€-sql-æœºåˆ¶" tabindex="-1">å…«ã€åŠ¨æ€ SQL æœºåˆ¶</h2>
<h3 id="8.1-åŠ¨æ€-sql-æ‰§è¡Œæµç¨‹" tabindex="-1">8.1 åŠ¨æ€ SQL æ‰§è¡Œæµç¨‹</h3>
<pre><code class="hljs">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è§£æ <span class="hljs-type">XML</span>        â”‚
â”‚  åŠ¨æ€ <span class="hljs-keyword">SQL</span> æ ‡ç­¾   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SqlSource       â”‚
â”‚  (<span class="hljs-keyword">SQL</span> æº)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  DynamicContext  â”‚
â”‚  (åŠ¨æ€ä¸Šä¸‹æ–‡)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SqlNode         â”‚
â”‚  (<span class="hljs-keyword">SQL</span> èŠ‚ç‚¹)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  BoundSql        â”‚
â”‚  (ç»‘å®š <span class="hljs-keyword">SQL</span>)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre>
<h3 id="8.2-sqlnode-å®ç°" tabindex="-1">8.2 SqlNode å®ç°</h3>
<pre><code class="hljs language-java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">SqlNode</span> {
    <span class="hljs-type">boolean</span> <span class="hljs-title function_">apply</span><span class="hljs-params">(DynamicContext context)</span>;
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">IfSqlNode</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">SqlNode</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ExpressionEvaluator evaluator;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String test;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> SqlNode contents;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">IfSqlNode</span><span class="hljs-params">(SqlNode contents, String test)</span> {
        <span class="hljs-built_in">this</span>.test = test;
        <span class="hljs-built_in">this</span>.contents = contents;
        <span class="hljs-built_in">this</span>.evaluator = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExpressionEvaluator</span>();
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">apply</span><span class="hljs-params">(DynamicContext context)</span> {
        <span class="hljs-keyword">if</span> (evaluator.evaluateBoolean(test, context.getBindings())) {
            contents.apply(context);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ForEachSqlNode</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">SqlNode</span> {
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">ITEM_PREFIX</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;__frch_&quot;</span>;
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ExpressionEvaluator evaluator;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String collectionExpression;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> SqlNode contents;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String open;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String close;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String separator;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String item;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String index;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String itemName;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String indexName;
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">apply</span><span class="hljs-params">(DynamicContext context)</span> {
        Map&lt;String, Object&gt; bindings = context.getBindings();
        <span class="hljs-keyword">final</span> Iterable&lt;?&gt; iterable = evaluator.evaluateIterable(collectionExpression, bindings);
        <span class="hljs-keyword">if</span> (!iterable.iterator().hasNext()) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
        <span class="hljs-type">boolean</span> <span class="hljs-variable">first</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;
        applyOpen(context);
        <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        <span class="hljs-keyword">for</span> (Object o : iterable) {
            <span class="hljs-type">DynamicContext</span> <span class="hljs-variable">oldContext</span> <span class="hljs-operator">=</span> context;
            <span class="hljs-keyword">if</span> (first) {
                first = <span class="hljs-literal">false</span>;
            } <span class="hljs-keyword">else</span> {
                applySeparator(context);
            }
            applyItem(context, o, i);
            contents.apply(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FilteredDynamicContext</span>(oldContext, index, item, i));
            i++;
        }
        applyClose(context);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
}
</code></pre>
<h2 id="ä¹ã€æ’ä»¶æœºåˆ¶" tabindex="-1">ä¹ã€æ’ä»¶æœºåˆ¶</h2>
<h3 id="9.1-æ‹¦æˆªå™¨é“¾" tabindex="-1">9.1 æ‹¦æˆªå™¨é“¾</h3>
<pre><code class="hljs language-java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Interceptor</span> {
    Object <span class="hljs-title function_">intercept</span><span class="hljs-params">(Invocation invocation)</span> <span class="hljs-keyword">throws</span> Throwable;
    Object <span class="hljs-title function_">plugin</span><span class="hljs-params">(Object target)</span>;
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">setProperties</span><span class="hljs-params">(Properties properties)</span>;
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InterceptorChain</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;Interceptor&gt; interceptors = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
    
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">pluginAll</span><span class="hljs-params">(Object target)</span> {
        <span class="hljs-keyword">for</span> (Interceptor interceptor : interceptors) {
            target = interceptor.plugin(target);
        }
        <span class="hljs-keyword">return</span> target;
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addInterceptor</span><span class="hljs-params">(Interceptor interceptor)</span> {
        interceptors.add(interceptor);
    }
    
    <span class="hljs-keyword">public</span> List&lt;Interceptor&gt; <span class="hljs-title function_">getInterceptors</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> Collections.unmodifiableList(interceptors);
    }
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Plugin</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InvocationHandler</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Object target;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Interceptor interceptor;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;Class&lt;?&gt;, Set&lt;Method&gt;&gt; signatureMap;
    
    <span class="hljs-keyword">private</span> <span class="hljs-title function_">Plugin</span><span class="hljs-params">(Object target, Interceptor interceptor, Map&lt;Class&lt;?&gt;, Set&lt;Method&gt;&gt; signatureMap)</span> {
        <span class="hljs-built_in">this</span>.target = target;
        <span class="hljs-built_in">this</span>.interceptor = interceptor;
        <span class="hljs-built_in">this</span>.signatureMap = signatureMap;
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">wrap</span><span class="hljs-params">(Object target, Interceptor interceptor)</span> {
        Map&lt;Class&lt;?&gt;, Set&lt;Method&gt;&gt; signatureMap = getSignatureMap(interceptor);
        Class&lt;?&gt; type = target.getClass();
        Class&lt;?&gt;[] interfaces = getAllInterfaces(type, signatureMap);
        <span class="hljs-keyword">if</span> (interfaces.length &gt; <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">return</span> Proxy.newProxyInstance(
                type.getClassLoader(),
                interfaces,
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Plugin</span>(target, interceptor, signatureMap));
        }
        <span class="hljs-keyword">return</span> target;
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] args)</span> <span class="hljs-keyword">throws</span> Throwable {
        <span class="hljs-keyword">try</span> {
            Set&lt;Method&gt; methods = signatureMap.get(method.getDeclaringClass());
            <span class="hljs-keyword">if</span> (methods != <span class="hljs-literal">null</span> &amp;&amp; methods.contains(method)) {
                <span class="hljs-keyword">return</span> interceptor.intercept(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Invocation</span>(target, method, args));
            }
            <span class="hljs-keyword">return</span> method.invoke(target, args);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">throw</span> ExceptionUtil.unwrapThrowable(e);
        }
    }
}
</code></pre>
<h2 id="åã€æ€»ç»“" tabindex="-1">åã€æ€»ç»“</h2>
<h3 id="10.1-mybatis-æ ¸å¿ƒæµç¨‹æ€»ç»“" tabindex="-1">10.1 MyBatis æ ¸å¿ƒæµç¨‹æ€»ç»“</h3>
<ol>
<li>
<p><strong>åˆå§‹åŒ–é˜¶æ®µ</strong>ï¼š</p>
<ul>
<li>è§£æé…ç½®æ–‡ä»¶ï¼ˆXMLConfigBuilderï¼‰</li>
<li>è§£æ Mapper æ–‡ä»¶ï¼ˆXMLMapperBuilderï¼‰</li>
<li>æ„å»º Configuration å¯¹è±¡</li>
<li>åˆ›å»º SqlSessionFactory</li>
</ul>
</li>
<li>
<p><strong>æ‰§è¡Œé˜¶æ®µ</strong>ï¼š</p>
<ul>
<li>é€šè¿‡ MapperProxy åŠ¨æ€ä»£ç†æ‰§è¡Œæ–¹æ³•</li>
<li>MapperMethod å°è£…æ–¹æ³•è°ƒç”¨</li>
<li>SqlSession ç®¡ç†ä¼šè¯</li>
<li>Executor æ‰§è¡Œ SQL</li>
<li>StatementHandler å¤„ç†è¯­å¥</li>
<li>ParameterHandler è®¾ç½®å‚æ•°</li>
<li>ResultSetHandler å¤„ç†ç»“æœé›†</li>
</ul>
</li>
<li>
<p><strong>æ‰©å±•æœºåˆ¶</strong>ï¼š</p>
<ul>
<li>æ’ä»¶æœºåˆ¶ï¼ˆInterceptor + Pluginï¼‰</li>
<li>ç¼“å­˜æœºåˆ¶ï¼ˆCache æ¥å£ + è£…é¥°å™¨ï¼‰</li>
<li>åŠ¨æ€ SQLï¼ˆSqlNode + DynamicContextï¼‰</li>
</ul>
</li>
</ol>
<h3 id="10.2-è®¾è®¡æ¨¡å¼æ€»ç»“" tabindex="-1">10.2 è®¾è®¡æ¨¡å¼æ€»ç»“</h3>
<table>
<thead>
<tr>
<th>è®¾è®¡æ¨¡å¼</th>
<th>åº”ç”¨åœºæ™¯</th>
<th>å…¸å‹ç±»</th>
</tr>
</thead>
<tbody>
<tr>
<td>å·¥å‚æ¨¡å¼</td>
<td>åˆ›å»º SqlSessionFactory</td>
<td>SqlSessionFactoryBuilder</td>
</tr>
<tr>
<td>å»ºé€ è€…æ¨¡å¼</td>
<td>æ„å»ºå¤æ‚å¯¹è±¡</td>
<td>XMLConfigBuilder, XMLMapperBuilder</td>
</tr>
<tr>
<td>ä»£ç†æ¨¡å¼</td>
<td>Mapper æ¥å£ä»£ç†</td>
<td>MapperProxy</td>
</tr>
<tr>
<td>ç­–ç•¥æ¨¡å¼</td>
<td>ä¸åŒçš„æ‰§è¡Œå™¨</td>
<td>SimpleExecutor, ReuseExecutor, BatchExecutor</td>
</tr>
<tr>
<td>è£…é¥°å™¨æ¨¡å¼</td>
<td>ç¼“å­˜åŠŸèƒ½å¢å¼º</td>
<td>LruCache, FifoCache</td>
</tr>
<tr>
<td>æ¨¡æ¿æ–¹æ³•æ¨¡å¼</td>
<td>æ‰§è¡Œå™¨åŸºç±»</td>
<td>BaseExecutor</td>
</tr>
<tr>
<td>è´£ä»»é“¾æ¨¡å¼</td>
<td>æ’ä»¶æ‹¦æˆª</td>
<td>InterceptorChain</td>
</tr>
</tbody>
</table>
<h3 id="10.3-å­¦ä¹ å»ºè®®" tabindex="-1">10.3 å­¦ä¹ å»ºè®®</h3>
<ol>
<li>ä»ç®€å•ç¤ºä¾‹å…¥æ‰‹ï¼Œç†è§£åŸºæœ¬ç”¨æ³•</li>
<li>é‡ç‚¹ç†è§£åˆå§‹åŒ–æµç¨‹å’Œæ‰§è¡Œæµç¨‹</li>
<li>æ·±å…¥ç ”ç©¶åŠ¨æ€ SQL çš„å®ç°æœºåˆ¶</li>
<li>å­¦ä¹ æ’ä»¶æœºåˆ¶å’Œç¼“å­˜æœºåˆ¶</li>
<li>ç»“åˆæºç è°ƒè¯•ï¼ŒåŠ æ·±ç†è§£</li>
</ol>
<p>é€šè¿‡æœ¬æ–‡çš„å­¦ä¹ ï¼Œä½ åº”è¯¥èƒ½å¤Ÿï¼š</p>
<ul>
<li>ç†è§£ MyBatis çš„æ•´ä½“æ¶æ„å’Œæ ¸å¿ƒç»„ä»¶</li>
<li>æŒæ¡ MyBatis çš„åˆå§‹åŒ–å’Œæ‰§è¡Œæµç¨‹</li>
<li>äº†è§£åŠ¨æ€ SQLã€ç¼“å­˜ã€æ’ä»¶ç­‰æ ¸å¿ƒæœºåˆ¶çš„å®ç°åŸç†</li>
<li>å…·å¤‡é˜…è¯»å’Œæ·±å…¥ MyBatis æºç çš„èƒ½åŠ›</li>
</ul>

        </div>
      </article>
    </div>
  </main>

  <footer class="footer">
    <div class="container">
      <p>&copy; 2026 zhizhi2213. All rights reserved.</p>
    </div>
  </footer>

  <script src="/static/assets/script.js"></script>
</body>
</html>
