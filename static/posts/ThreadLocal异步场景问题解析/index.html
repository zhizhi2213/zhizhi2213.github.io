<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ThreadLocalå¼‚æ­¥åœºæ™¯é—®é¢˜è§£æ - å±å±çš„åšå®¢</title>
  <meta name="description" content="{{post.excerpt}}">
  <link rel="stylesheet" href="/static/assets/style.css">
</head>
<body>
  <div class="background-animation"></div>
  <div class="background-animation background-animation-2"></div>
  
  <header class="header">
    <div class="container">
      <nav class="nav">
        <a href="/" class="logo">å±å±çš„åšå®¢</a>
        <div class="nav-links">
          <a href="/" class="nav-link">é¦–é¡µ</a>
          <a href="/static/archives/" class="nav-link">å½’æ¡£</a>
        </div>
        <button class="theme-toggle" aria-label="åˆ‡æ¢ä¸»é¢˜">
          <span class="theme-icon">ğŸŒ™</span>
        </button>
      </nav>
    </div>
  </header>

  <main class="main">
    <div class="container">
      <article class="post">
        <div class="post-header">
          <a href="/" class="back-link">â† è¿”å›é¦–é¡µ</a>
          <h1 class="post-title">ThreadLocalå¼‚æ­¥åœºæ™¯é—®é¢˜è§£æ</h1>
          <div class="post-meta">
            <span class="post-date">2026å¹´2æœˆ11æ—¥</span>
            
          </div>
        </div>
        
        <div class="post-content">
          <h1>ThreadLocal å¼‚æ­¥åœºæ™¯é—®é¢˜è§£æ</h1>
<h2 id="é—®é¢˜å¼•å…¥" tabindex="-1">é—®é¢˜å¼•å…¥</h2>
<p><strong>é¢è¯•å®˜é—®ï¼šThreadLocal åœ¨å¼‚æ­¥åœºæ™¯ä¸‹æœ‰é—®é¢˜å—ï¼Ÿ</strong></p>
<p>è¿™æ˜¯ä¸€ä¸ªéå¸¸ç»å…¸çš„å¹¶å‘ç¼–ç¨‹é¢è¯•é¢˜ï¼Œè€ƒå¯Ÿå€™é€‰äººå¯¹ ThreadLocal åŸç†çš„ç†è§£ï¼Œä»¥åŠåœ¨å¼‚æ­¥åœºæ™¯ä¸‹çš„ä½¿ç”¨ç»éªŒã€‚</p>
<h2 id="ä¸€ã€threadlocal-åœ¨å¼‚æ­¥åœºæ™¯ä¸‹ä¼šå¤±æ•ˆå—ï¼Ÿ" tabindex="-1">ä¸€ã€ThreadLocal åœ¨å¼‚æ­¥åœºæ™¯ä¸‹ä¼šå¤±æ•ˆå—ï¼Ÿ</h2>
<p><strong>ç­”æ¡ˆï¼šæ˜¯çš„ï¼ŒThreadLocal åœ¨å¼‚æ­¥åœºæ™¯ä¸‹ä¼šå¤±æ•ˆã€‚</strong></p>
<h3 id="1.1-å¤±æ•ˆåŸå› " tabindex="-1">1.1 å¤±æ•ˆåŸå› </h3>
<p>ThreadLocal çš„å€¼é»˜è®¤æ˜¯æ— æ³•è·¨çº¿ç¨‹ä¼ é€’çš„ï¼ŒåŸå› å¦‚ä¸‹ï¼š</p>
<pre><code class="hljs language-java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Thread</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Runnable</span> {
    ThreadLocal.<span class="hljs-type">ThreadLocalMap</span> <span class="hljs-variable">threadLocals</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
    ThreadLocal.<span class="hljs-type">ThreadLocalMap</span> <span class="hljs-variable">inheritableThreadLocals</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
}
</code></pre>
<p>ä» Thread ç±»çš„æºç å¯ä»¥çœ‹å‡ºï¼Œæ¯ä¸ª Thread å¯¹è±¡éƒ½æœ‰è‡ªå·±ç‹¬ç«‹çš„ <code>ThreadLocalMap</code>ã€‚ThreadLocal çš„å€¼å°±å­˜å‚¨åœ¨è¿™ä¸ª Map ä¸­ï¼Œkey æ˜¯ ThreadLocal å¯¹è±¡æœ¬èº«ï¼Œvalue æ˜¯å­˜å‚¨çš„æ•°æ®ã€‚</p>
<p><strong>æ ¸å¿ƒé—®é¢˜ï¼š</strong></p>
<ul>
<li>çˆ¶çº¿ç¨‹å’Œå­çº¿ç¨‹æ˜¯ä¸¤ä¸ªä¸åŒçš„ Thread å¯¹è±¡</li>
<li>å®ƒä»¬å„è‡ªæ‹¥æœ‰ç‹¬ç«‹çš„ ThreadLocalMap</li>
<li>å› æ­¤çˆ¶çº¿ç¨‹ä¸­çš„ ThreadLocal å€¼æ— æ³•è‡ªåŠ¨ä¼ é€’ç»™å­çº¿ç¨‹</li>
</ul>
<h3 id="1.2-ä»£ç ç¤ºä¾‹" tabindex="-1">1.2 ä»£ç ç¤ºä¾‹</h3>
<pre><code class="hljs language-java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ThreadLocalDemo</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ThreadLocal&lt;String&gt; threadLocal = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadLocal</span>&lt;&gt;();

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        threadLocal.set(<span class="hljs-string">&quot;ä¸»çº¿ç¨‹çš„å€¼&quot;</span>);

        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
            System.out.println(<span class="hljs-string">&quot;å­çº¿ç¨‹è·å–åˆ°çš„å€¼: &quot;</span> + threadLocal.get());
        }).start();

        System.out.println(<span class="hljs-string">&quot;ä¸»çº¿ç¨‹çš„å€¼: &quot;</span> + threadLocal.get());
    }
}
</code></pre>
<p><strong>è¾“å‡ºç»“æœï¼š</strong></p>
<pre><code class="hljs"><span class="hljs-section">ä¸»çº¿ç¨‹çš„å€¼: ä¸»çº¿ç¨‹çš„å€¼</span>
<span class="hljs-section">å­çº¿ç¨‹è·å–åˆ°çš„å€¼: null</span>
</code></pre>
<p>å¯ä»¥çœ‹åˆ°ï¼Œå­çº¿ç¨‹ä¸­è·å–åˆ°çš„æ˜¯ <code>null</code>ï¼Œè¯´æ˜ ThreadLocal çš„å€¼æ²¡æœ‰ä¼ é€’åˆ°å­çº¿ç¨‹ã€‚</p>
<h2 id="äºŒã€å¦‚ä½•è·¨çº¿ç¨‹ä¼ é€’-threadlocal-çš„å€¼ï¼Ÿ" tabindex="-1">äºŒã€å¦‚ä½•è·¨çº¿ç¨‹ä¼ é€’ ThreadLocal çš„å€¼ï¼Ÿ</h2>
<p>é’ˆå¯¹è¿™ä¸ªé—®é¢˜ï¼Œä¸»è¦æœ‰ä¸¤ç§è§£å†³æ–¹æ¡ˆï¼š</p>
<h3 id="2.1-æ–¹æ¡ˆä¸€ï¼šjdk-çš„-inheritablethreadlocal" tabindex="-1">2.1 æ–¹æ¡ˆä¸€ï¼šJDK çš„ InheritableThreadLocal</h3>
<p>InheritableThreadLocal æ˜¯ JDK æä¾›çš„ä¸€ç§ç‰¹æ®Š ThreadLocalï¼Œå¯ä»¥åœ¨åˆ›å»ºå­çº¿ç¨‹æ—¶å°†çˆ¶çº¿ç¨‹çš„å€¼å¤åˆ¶ç»™å­çº¿ç¨‹ã€‚</p>
<h4 id="2.1.1-ä½¿ç”¨ç¤ºä¾‹" tabindex="-1">2.1.1 ä½¿ç”¨ç¤ºä¾‹</h4>
<pre><code class="hljs language-java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InheritableThreadLocalDemo</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> InheritableThreadLocal&lt;String&gt; inheritableThreadLocal = 
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">InheritableThreadLocal</span>&lt;&gt;();

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        inheritableThreadLocal.set(<span class="hljs-string">&quot;ä¸»çº¿ç¨‹çš„å€¼&quot;</span>);

        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
            System.out.println(<span class="hljs-string">&quot;å­çº¿ç¨‹è·å–åˆ°çš„å€¼: &quot;</span> + inheritableThreadLocal.get());
        }).start();

        System.out.println(<span class="hljs-string">&quot;ä¸»çº¿ç¨‹çš„å€¼: &quot;</span> + inheritableThreadLocal.get());
    }
}
</code></pre>
<p><strong>è¾“å‡ºç»“æœï¼š</strong></p>
<pre><code class="hljs"><span class="hljs-section">ä¸»çº¿ç¨‹çš„å€¼: ä¸»çº¿ç¨‹çš„å€¼</span>
<span class="hljs-section">å­çº¿ç¨‹è·å–åˆ°çš„å€¼: ä¸»çº¿ç¨‹çš„å€¼</span>
</code></pre>
<h4 id="2.1.2-åŸç†åˆ†æ" tabindex="-1">2.1.2 åŸç†åˆ†æ</h4>
<p>InheritableThreadLocal ç»§æ‰¿è‡ª ThreadLocalï¼Œé‡å†™äº†ä¸‰ä¸ªæ ¸å¿ƒæ–¹æ³•ï¼š</p>
<pre><code class="hljs language-java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InheritableThreadLocal</span>&lt;T&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ThreadLocal</span>&lt;T&gt; {
    
    <span class="hljs-keyword">protected</span> T <span class="hljs-title function_">childValue</span><span class="hljs-params">(T parentValue)</span> {
        <span class="hljs-keyword">return</span> parentValue;
    }

    ThreadLocalMap <span class="hljs-title function_">getMap</span><span class="hljs-params">(Thread t)</span> {
        <span class="hljs-keyword">return</span> t.inheritableThreadLocals;
    }

    <span class="hljs-keyword">void</span> <span class="hljs-title function_">createMap</span><span class="hljs-params">(Thread t, T firstValue)</span> {
        t.inheritableThreadLocals = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadLocalMap</span>(<span class="hljs-built_in">this</span>, firstValue);
    }
}
</code></pre>
<p><strong>æ ¸å¿ƒæœºåˆ¶ï¼š</strong></p>
<ol>
<li>Thread ç±»ä¸­æœ‰ä¸¤ä¸ª ThreadLocalMapï¼š<code>threadLocals</code> å’Œ <code>inheritableThreadLocals</code></li>
<li>InheritableThreadLocal ä½¿ç”¨ <code>inheritableThreadLocals</code> æ¥å­˜å‚¨å€¼</li>
<li>å½“åˆ›å»ºå­çº¿ç¨‹æ—¶ï¼ŒThread çš„æ„é€ æ–¹æ³•ä¼šè°ƒç”¨ <code>Thread.init()</code> æ–¹æ³•ï¼š<pre><code class="hljs language-java"><span class="hljs-keyword">if</span> (parent.inheritableThreadLocals != <span class="hljs-literal">null</span>)
    <span class="hljs-built_in">this</span>.inheritableThreadLocals = 
        ThreadLocal.createInheritedMap(parent.inheritableThreadLocals);
</code></pre>
</li>
</ol>
<h4 id="2.1.3-çº¿ç¨‹æ± åœºæ™¯ä¸‹çš„é—®é¢˜" tabindex="-1">2.1.3 çº¿ç¨‹æ± åœºæ™¯ä¸‹çš„é—®é¢˜</h4>
<p>InheritableThreadLocal åœ¨çº¿ç¨‹æ± åœºæ™¯ä¸‹ä¼šå¤±æ•ˆï¼ŒåŸå› å¦‚ä¸‹ï¼š</p>
<pre><code class="hljs language-java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InheritableThreadLocalPoolDemo</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> InheritableThreadLocal&lt;String&gt; inheritableThreadLocal = 
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">InheritableThreadLocal</span>&lt;&gt;();
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">1</span>);

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++) {
            inheritableThreadLocal.set(<span class="hljs-string">&quot;ä»»åŠ¡-&quot;</span> + i);
            
            executor.submit(() -&gt; {
                System.out.println(<span class="hljs-string">&quot;çº¿ç¨‹å: &quot;</span> + Thread.currentThread().getName() + 
                                 <span class="hljs-string">&quot;, è·å–åˆ°çš„å€¼: &quot;</span> + inheritableThreadLocal.get());
            });
        }
    }
}
</code></pre>
<p><strong>å¯èƒ½è¾“å‡ºï¼š</strong></p>
<pre><code class="hljs">çº¿ç¨‹å: pool<span class="hljs-string">-1</span>-thread<span class="hljs-string">-1</span>, è·å–åˆ°çš„å€¼: ä»»åŠ¡<span class="hljs-string">-0</span>
çº¿ç¨‹å: pool<span class="hljs-string">-1</span>-thread<span class="hljs-string">-1</span>, è·å–åˆ°çš„å€¼: ä»»åŠ¡<span class="hljs-string">-0</span>
çº¿ç¨‹å: pool<span class="hljs-string">-1</span>-thread<span class="hljs-string">-1</span>, è·å–åˆ°çš„å€¼: ä»»åŠ¡<span class="hljs-string">-0</span>
</code></pre>
<p><strong>é—®é¢˜åˆ†æï¼š</strong></p>
<ul>
<li>çº¿ç¨‹æ± ä¼šå¤ç”¨çº¿ç¨‹ï¼Œä¸ä¼šæ¯æ¬¡éƒ½åˆ›å»ºæ–°çº¿ç¨‹</li>
<li>InheritableThreadLocal åªåœ¨çº¿ç¨‹åˆ›å»ºæ—¶å¤åˆ¶ä¸€æ¬¡å€¼</li>
<li>åç»­å¤ç”¨çº¿ç¨‹æ—¶ï¼Œä»ç„¶ä½¿ç”¨çš„æ˜¯ç¬¬ä¸€æ¬¡å¤åˆ¶è¿‡æ¥çš„å€¼</li>
<li>è¿™ä¼šå¯¼è‡´çº¿ç¨‹æ‹¿åˆ°çš„å¯èƒ½æ˜¯ä¸Šä¸€ä¸ªä»»åŠ¡ä¼ ä¸‹æ¥çš„è„æ•°æ®</li>
</ul>
<h3 id="2.2-æ–¹æ¡ˆäºŒï¼šé˜¿é‡Œçš„-transmittablethreadlocal-(ttl)" tabindex="-1">2.2 æ–¹æ¡ˆäºŒï¼šé˜¿é‡Œçš„ TransmittableThreadLocal (TTL)</h3>
<p>TransmittableThreadLocal æ˜¯é˜¿é‡Œå¼€æºçš„ TTL åº“æä¾›çš„è§£å†³æ–¹æ¡ˆï¼Œä¸“é—¨è§£å†³çº¿ç¨‹æ± åœºæ™¯ä¸‹ ThreadLocal çš„ä¼ é€’é—®é¢˜ã€‚</p>
<h4 id="2.2.1-ä½¿ç”¨ç¤ºä¾‹" tabindex="-1">2.2.1 ä½¿ç”¨ç¤ºä¾‹</h4>
<pre><code class="hljs language-java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TransmittableThreadLocalDemo</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> TransmittableThreadLocal&lt;String&gt; transmittableThreadLocal = 
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransmittableThreadLocal</span>&lt;&gt;();
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> TtlExecutors.getTtlExecutorService(
        Executors.newFixedThreadPool(<span class="hljs-number">1</span>));

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++) {
            transmittableThreadLocal.set(<span class="hljs-string">&quot;ä»»åŠ¡-&quot;</span> + i);
            
            executor.submit(() -&gt; {
                System.out.println(<span class="hljs-string">&quot;çº¿ç¨‹å: &quot;</span> + Thread.currentThread().getName() + 
                                 <span class="hljs-string">&quot;, è·å–åˆ°çš„å€¼: &quot;</span> + transmittableThreadLocal.get());
            });
        }
    }
}
</code></pre>
<p><strong>è¾“å‡ºç»“æœï¼š</strong></p>
<pre><code class="hljs">çº¿ç¨‹å: pool<span class="hljs-string">-1</span>-thread<span class="hljs-string">-1</span>, è·å–åˆ°çš„å€¼: ä»»åŠ¡<span class="hljs-string">-0</span>
çº¿ç¨‹å: pool<span class="hljs-string">-1</span>-thread<span class="hljs-string">-1</span>, è·å–åˆ°çš„å€¼: ä»»åŠ¡<span class="hljs-string">-1</span>
çº¿ç¨‹å: pool<span class="hljs-string">-1</span>-thread<span class="hljs-string">-1</span>, è·å–åˆ°çš„å€¼: ä»»åŠ¡<span class="hljs-string">-2</span>
</code></pre>
<p>å¯ä»¥çœ‹åˆ°ï¼Œå³ä½¿çº¿ç¨‹æ± å¤ç”¨çº¿ç¨‹ï¼Œæ¯ä¸ªä»»åŠ¡éƒ½èƒ½è·å–åˆ°æ­£ç¡®çš„å€¼ã€‚</p>
<h4 id="2.2.2-åŸç†åˆ†æ" tabindex="-1">2.2.2 åŸç†åˆ†æ</h4>
<p>TransmittableThreadLocal çš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼š<strong>å°† ThreadLocal çš„å€¼ä¸ä»»åŠ¡ç»‘å®šï¼Œè€Œä¸æ˜¯ä¸çº¿ç¨‹ç»‘å®šã€‚</strong></p>
<p><strong>å·¥ä½œæµç¨‹ï¼š</strong></p>
<ol>
<li>
<p><strong>æ•è·é˜¶æ®µï¼š</strong> åœ¨æäº¤ä»»åŠ¡åˆ°çº¿ç¨‹æ± æ—¶ï¼Œæ•è·çˆ¶çº¿ç¨‹çš„ ThreadLocal å€¼</p>
<pre><code class="hljs language-java"><span class="hljs-comment">// TtlRunnable æºç ç®€åŒ–</span>
<span class="hljs-keyword">public</span> <span class="hljs-title function_">TtlRunnable</span><span class="hljs-params">(Runnable runnable)</span> {
    <span class="hljs-built_in">this</span>.captured = TransmittableThreadLocal.Transmitter.capture();
    <span class="hljs-built_in">this</span>.runnable = runnable;
}
</code></pre>
</li>
<li>
<p><strong>æ¢å¤é˜¶æ®µï¼š</strong> ä»»åŠ¡æ‰§è¡Œå‰ï¼Œå°†æ•è·çš„å€¼è®¾ç½®åˆ°å½“å‰çº¿ç¨‹</p>
<pre><code class="hljs language-java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> {
    <span class="hljs-type">Object</span> <span class="hljs-variable">backup</span> <span class="hljs-operator">=</span> TransmittableThreadLocal.Transmitter.replay(captured);
    <span class="hljs-keyword">try</span> {
        runnable.run();
    } <span class="hljs-keyword">finally</span> {
        TransmittableThreadLocal.Transmitter.restore(backup);
    }
}
</code></pre>
</li>
<li>
<p><strong>æ¸…ç†é˜¶æ®µï¼š</strong> ä»»åŠ¡æ‰§è¡Œå®Œæˆåï¼Œæ¢å¤çº¿ç¨‹åŸæ¥çš„å€¼</p>
</li>
</ol>
<p><strong>æ ¸å¿ƒæœºåˆ¶å¯¹æ¯”ï¼š</strong></p>
<table>
<thead>
<tr>
<th>ç‰¹æ€§</th>
<th>InheritableThreadLocal</th>
<th>TransmittableThreadLocal</th>
</tr>
</thead>
<tbody>
<tr>
<td>ç»‘å®šå¯¹è±¡</td>
<td>çº¿ç¨‹</td>
<td>ä»»åŠ¡</td>
</tr>
<tr>
<td>å¤åˆ¶æ—¶æœº</td>
<td>çº¿ç¨‹åˆ›å»ºæ—¶</td>
<td>ä»»åŠ¡æäº¤æ—¶</td>
</tr>
<tr>
<td>çº¿ç¨‹æ± æ”¯æŒ</td>
<td>ä¸æ”¯æŒ</td>
<td>æ”¯æŒ</td>
</tr>
<tr>
<td>é€‚ç”¨åœºæ™¯</td>
<td>ç®€å•çˆ¶å­çº¿ç¨‹</td>
<td>çº¿ç¨‹æ± ã€å¼‚æ­¥åœºæ™¯</td>
</tr>
</tbody>
</table>
<h2 id="ä¸‰ã€é¢è¯•å›ç­”æ€»ç»“" tabindex="-1">ä¸‰ã€é¢è¯•å›ç­”æ€»ç»“</h2>
<p><strong>é¢è¯•å®˜ï¼šThreadLocal å¼‚æ­¥åœºæ™¯æœ‰é—®é¢˜å—ï¼Ÿ</strong></p>
<p><strong>å®Œæ•´å›ç­”ï¼š</strong></p>
<blockquote>
<p>ThreadLocal åœ¨å¼‚æ­¥åœºæ™¯ä¸‹ç¡®å®ä¼šæœ‰é—®é¢˜ã€‚å®ƒçš„å€¼å­˜å‚¨åœ¨æ¯ä¸ªçº¿ç¨‹ç‹¬ç«‹çš„ ThreadLocalMap ä¸­ï¼Œçˆ¶å­çº¿ç¨‹æ˜¯ä¸¤ä¸ªä¸åŒçš„å¯¹è±¡ï¼Œå› æ­¤å€¼æ— æ³•è‡ªåŠ¨ä¼ é€’ã€‚</p>
<p>è§£å†³æ–¹æ¡ˆä¸»è¦æœ‰ä¸¤ç§ï¼š</p>
<ol>
<li>
<p><strong>InheritableThreadLocal</strong>ï¼šJDK æä¾›çš„æ–¹æ¡ˆï¼Œåœ¨åˆ›å»ºå­çº¿ç¨‹æ—¶å°†çˆ¶çº¿ç¨‹çš„å€¼å¤åˆ¶ç»™å­çº¿ç¨‹ã€‚ä½†å®ƒåœ¨çº¿ç¨‹æ± åœºæ™¯ä¸‹ä¼šå¤±æ•ˆï¼Œå› ä¸ºçº¿ç¨‹æ± ä¼šå¤ç”¨çº¿ç¨‹ï¼Œå¯¼è‡´çº¿ç¨‹æ‹¿åˆ°çš„å¯èƒ½æ˜¯è„æ•°æ®ã€‚</p>
</li>
<li>
<p><strong>TransmittableThreadLocal</strong>ï¼šé˜¿é‡Œå¼€æºçš„ TTL åº“æä¾›çš„æ–¹æ¡ˆã€‚å®ƒçš„åŸç†æ˜¯åœ¨æäº¤ä»»åŠ¡åˆ°çº¿ç¨‹æ± æ—¶ï¼ŒæŠŠçˆ¶çº¿ç¨‹çš„ ThreadLocal å€¼æ•è·ä¸‹æ¥ï¼Œå’Œä»»åŠ¡ç»‘å®šåœ¨ä¸€èµ·ã€‚ç­‰çº¿ç¨‹æ± é‡Œçš„æŸä¸ªçº¿ç¨‹è¦æ‰§è¡Œè¿™ä¸ªä»»åŠ¡æ—¶ï¼Œå†æŠŠæ•è·çš„å€¼è®¾ç½®åˆ°è¿™ä¸ªçº¿ç¨‹ä¸Šï¼Œä»»åŠ¡æ‰§è¡Œå®Œå†æ¸…ç†æ‰ã€‚</p>
</li>
</ol>
<p>ç®€å•è¯´ï¼ŒInheritableThreadLocal æ˜¯è·Ÿçº¿ç¨‹ç»‘å®šçš„ï¼Œåªåœ¨åˆ›å»ºæ—¶æœ‰æ•ˆï¼›è€Œ TTL æ˜¯è·Ÿä»»åŠ¡ç»‘å®šçš„ï¼Œå®Œç¾æ”¯æŒçº¿ç¨‹æ± ã€‚</p>
</blockquote>
<h2 id="å››ã€å®é™…åº”ç”¨åœºæ™¯" tabindex="-1">å››ã€å®é™…åº”ç”¨åœºæ™¯</h2>
<h3 id="4.1-åˆ†å¸ƒå¼è¿½è¸ª" tabindex="-1">4.1 åˆ†å¸ƒå¼è¿½è¸ª</h3>
<pre><code class="hljs language-java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TraceContext</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> TransmittableThreadLocal&lt;String&gt; traceId = 
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransmittableThreadLocal</span>&lt;&gt;();

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setTraceId</span><span class="hljs-params">(String id)</span> {
        traceId.set(id);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getTraceId</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> traceId.get();
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">clear</span><span class="hljs-params">()</span> {
        traceId.remove();
    }
}
</code></pre>
<h3 id="4.2-ç”¨æˆ·ä¸Šä¸‹æ–‡ä¼ é€’" tabindex="-1">4.2 ç”¨æˆ·ä¸Šä¸‹æ–‡ä¼ é€’</h3>
<pre><code class="hljs language-java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserContext</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> TransmittableThreadLocal&lt;User&gt; currentUser = 
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransmittableThreadLocal</span>&lt;&gt;();

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setCurrentUser</span><span class="hljs-params">(User user)</span> {
        currentUser.set(user);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> User <span class="hljs-title function_">getCurrentUser</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> currentUser.get();
    }
}
</code></pre>
<h3 id="4.3-æ•°æ®åº“åŠ¨æ€æ•°æ®æºåˆ‡æ¢" tabindex="-1">4.3 æ•°æ®åº“åŠ¨æ€æ•°æ®æºåˆ‡æ¢</h3>
<pre><code class="hljs language-java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DataSourceContextHolder</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> TransmittableThreadLocal&lt;String&gt; dataSourceKey = 
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransmittableThreadLocal</span>&lt;&gt;();

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setDataSourceKey</span><span class="hljs-params">(String key)</span> {
        dataSourceKey.set(key);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getDataSourceKey</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> dataSourceKey.get();
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">clearDataSourceKey</span><span class="hljs-params">()</span> {
        dataSourceKey.remove();
    }
}
</code></pre>
<h2 id="äº”ã€æ³¨æ„äº‹é¡¹" tabindex="-1">äº”ã€æ³¨æ„äº‹é¡¹</h2>
<ol>
<li><strong>å†…å­˜æ³„æ¼é£é™©</strong>ï¼šä½¿ç”¨ ThreadLocal åä¸€å®šè¦è°ƒç”¨ <code>remove()</code> æ–¹æ³•æ¸…ç†ï¼Œå¦åˆ™å¯èƒ½å¯¼è‡´å†…å­˜æ³„æ¼</li>
<li><strong>TTL è£…é¥°å™¨</strong>ï¼šä½¿ç”¨ TTL æ—¶ï¼Œéœ€è¦ç”¨ <code>TtlExecutors</code>ã€<code>TtlForkJoinPool</code> ç­‰è£…é¥°å™¨åŒ…è£…çº¿ç¨‹æ± </li>
<li><strong>æ€§èƒ½è€ƒè™‘</strong>ï¼šTTL çš„æ•è·å’Œæ¢å¤æœºåˆ¶ä¼šå¸¦æ¥ä¸€å®šçš„æ€§èƒ½å¼€é”€ï¼Œåœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹éœ€è¦æ³¨æ„</li>
<li><strong>å€¼ä¸å¯å˜</strong>ï¼šThreadLocal ä¸­å­˜å‚¨çš„å¯¹è±¡æœ€å¥½æ˜¯ä¸å¯å˜çš„ï¼Œé¿å…å¤šçº¿ç¨‹ä¿®æ”¹å¸¦æ¥çš„é—®é¢˜</li>
</ol>
<h2 id="å…­ã€æ€»ç»“" tabindex="-1">å…­ã€æ€»ç»“</h2>
<table>
<thead>
<tr>
<th>æ–¹æ¡ˆ</th>
<th>é€‚ç”¨åœºæ™¯</th>
<th>ä¼˜ç‚¹</th>
<th>ç¼ºç‚¹</th>
</tr>
</thead>
<tbody>
<tr>
<td>ThreadLocal</td>
<td>å•çº¿ç¨‹</td>
<td>ç®€å•é«˜æ•ˆ</td>
<td>æ— æ³•è·¨çº¿ç¨‹</td>
</tr>
<tr>
<td>InheritableThreadLocal</td>
<td>ç®€å•çˆ¶å­çº¿ç¨‹</td>
<td>JDK åŸç”Ÿæ”¯æŒ</td>
<td>çº¿ç¨‹æ± å¤±æ•ˆ</td>
</tr>
<tr>
<td>TransmittableThreadLocal</td>
<td>çº¿ç¨‹æ± ã€å¼‚æ­¥</td>
<td>å®Œç¾æ”¯æŒçº¿ç¨‹æ± </td>
<td>éœ€è¦å¼•å…¥ä¾èµ–</td>
</tr>
</tbody>
</table>
<p>åœ¨å®é™…é¡¹ç›®ä¸­ï¼Œæ¨èä½¿ç”¨ TransmittableThreadLocalï¼Œå› ä¸ºå®ƒèƒ½å¤Ÿå®Œç¾è§£å†³çº¿ç¨‹æ± åœºæ™¯ä¸‹ ThreadLocal ä¼ é€’çš„é—®é¢˜ã€‚</p>

        </div>
      </article>
    </div>
  </main>

  <footer class="footer">
    <div class="container">
      <p>&copy; 2026 zhizhi2213. All rights reserved.</p>
    </div>
  </footer>

  <script src="/static/assets/script.js"></script>
</body>
</html>
