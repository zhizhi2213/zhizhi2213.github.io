<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ThreadLocalå¼‚æ­¥åœºæ™¯é—®é¢˜è§£æ - å±å±çš„åšå®¢</title>
  <meta name="description" content="ThreadLocal å¼‚æ­¥åœºæ™¯é—®é¢˜è§£æ

 é—®é¢˜å¼•å…¥

é¢è¯•å®˜é—®ï¼šThreadLocal åœ¨å¼‚æ­¥åœºæ™¯ä¸‹æœ‰é—®é¢˜å—ï¼Ÿ

è¿™æ˜¯ä¸€ä¸ªéå¸¸ç»å…¸çš„å¹¶å‘ç¼–ç¨‹é¢è¯•é¢˜ï¼Œè€ƒå¯Ÿå€™é€‰äººå¯¹ ThreadLocal åŸç†çš„ç†è§£ï¼Œä»¥åŠåœ¨å¼‚æ­¥åœºæ™¯ä¸‹çš„ä½¿ç”¨ç»éªŒã€‚

 ä¸€ã€ThreadLocal åœ¨å¼‚æ­¥åœºæ™¯ä¸‹ä¼šå¤±æ•ˆå—ï¼Ÿ

ç­”æ¡ˆï¼šæ˜¯çš„...">
  <meta name="theme-color" content="#6366f1">
  <meta property="og:title" content="ThreadLocalå¼‚æ­¥åœºæ™¯é—®é¢˜è§£æ">
  <meta property="og:description" content="ThreadLocal å¼‚æ­¥åœºæ™¯é—®é¢˜è§£æ

 é—®é¢˜å¼•å…¥

é¢è¯•å®˜é—®ï¼šThreadLocal åœ¨å¼‚æ­¥åœºæ™¯ä¸‹æœ‰é—®é¢˜å—ï¼Ÿ

è¿™æ˜¯ä¸€ä¸ªéå¸¸ç»å…¸çš„å¹¶å‘ç¼–ç¨‹é¢è¯•é¢˜ï¼Œè€ƒå¯Ÿå€™é€‰äººå¯¹ ThreadLocal åŸç†çš„ç†è§£ï¼Œä»¥åŠåœ¨å¼‚æ­¥åœºæ™¯ä¸‹çš„ä½¿ç”¨ç»éªŒã€‚

 ä¸€ã€ThreadLocal åœ¨å¼‚æ­¥åœºæ™¯ä¸‹ä¼šå¤±æ•ˆå—ï¼Ÿ

ç­”æ¡ˆï¼šæ˜¯çš„...">
  <meta property="og:type" content="article">
  <meta property="og:url" content="https://zhizhi2213.github.io/static/posts/ThreadLocalå¼‚æ­¥åœºæ™¯é—®é¢˜è§£æ/">
  <meta property="og:site_name" content="å±å±çš„åšå®¢">
  <meta property="og:locale" content="zh_CN">
  <meta property="article:author" content="zhizhi2213">
  <meta property="article:published_time" content="2026å¹´2æœˆ11æ—¥">
  
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="ThreadLocalå¼‚æ­¥åœºæ™¯é—®é¢˜è§£æ">
  <meta name="twitter:description" content="ThreadLocal å¼‚æ­¥åœºæ™¯é—®é¢˜è§£æ

 é—®é¢˜å¼•å…¥

é¢è¯•å®˜é—®ï¼šThreadLocal åœ¨å¼‚æ­¥åœºæ™¯ä¸‹æœ‰é—®é¢˜å—ï¼Ÿ

è¿™æ˜¯ä¸€ä¸ªéå¸¸ç»å…¸çš„å¹¶å‘ç¼–ç¨‹é¢è¯•é¢˜ï¼Œè€ƒå¯Ÿå€™é€‰äººå¯¹ ThreadLocal åŸç†çš„ç†è§£ï¼Œä»¥åŠåœ¨å¼‚æ­¥åœºæ™¯ä¸‹çš„ä½¿ç”¨ç»éªŒã€‚

 ä¸€ã€ThreadLocal åœ¨å¼‚æ­¥åœºæ™¯ä¸‹ä¼šå¤±æ•ˆå—ï¼Ÿ

ç­”æ¡ˆï¼šæ˜¯çš„...">
  <link rel="stylesheet" href="/static/assets/style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
</head>
<body>
  <div class="background-animation"></div>
  <div class="background-animation background-animation-2"></div>
  
  <div class="reading-progress-bar" id="readingProgressBar"></div>
  
  <a href="#main-content" class="skip-link">è·³è½¬åˆ°ä¸»è¦å†…å®¹</a>
  
  <header class="header">
    <div class="container">
      <nav class="nav">
        <a href="/" class="logo">å±å±çš„åšå®¢</a>
        <div class="nav-links">
          <a href="/" class="nav-link">é¦–é¡µ</a>
          <a href="/static/archives/" class="nav-link">å½’æ¡£</a>
          <a href="/static/tags/" class="nav-link">æ ‡ç­¾</a>
        </div>
        <div class="header-actions">
          <button class="search-toggle" aria-label="æœç´¢">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
          </button>
          <button class="theme-toggle" aria-label="åˆ‡æ¢ä¸»é¢˜">
            <span class="theme-icon">ğŸŒ™</span>
          </button>
          <button class="mobile-menu-toggle" id="mobileMenuToggle" aria-label="æ‰“å¼€èœå•">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
          </button>
        </div>
      </nav>
      
      <div class="mobile-menu" id="mobileMenu">
        <div class="mobile-menu-backdrop" id="mobileMenuBackdrop"></div>
        <div class="mobile-menu-content">
          <div class="mobile-menu-header">
            <a href="/" class="logo">å±å±çš„åšå®¢</a>
            <button class="mobile-menu-close" id="mobileMenuClose" aria-label="å…³é—­èœå•">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
          </div>
          <div class="mobile-menu-links">
            <a href="/" class="mobile-menu-link">é¦–é¡µ</a>
            <a href="/static/archives/" class="mobile-menu-link">å½’æ¡£</a>
            <a href="/static/tags/" class="mobile-menu-link">æ ‡ç­¾</a>
          </div>
        </div>
      </div>
    </div>
  </header>

  <div class="search-modal" id="searchModal">
    <div class="search-modal-backdrop" id="searchBackdrop"></div>
    <div class="search-modal-content">
      <div class="search-header">
        <input type="text" class="search-input" id="searchInput" placeholder="æœç´¢æ–‡ç« ..." autocomplete="off">
        <button class="search-close" id="searchClose" aria-label="å…³é—­æœç´¢">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        </button>
      </div>
      <div class="search-results" id="searchResults"></div>
    </div>
  </div>

  <main class="main" id="main-content">
    <div class="post-layout-container">
      <div class="post-layout">
        <aside class="posts-sidebar">
          <h3 class="posts-sidebar-title">æ–‡ç« ç›®å½•</h3>
          <nav class="posts-sidebar-content" id="postsSidebarContent">
            <ul class="posts-sidebar-list">
              
              <li class="posts-sidebar-item">
                <a href="/static/posts/MyBatisæºç æ·±åº¦è§£æ/" class="posts-sidebar-link">MyBatisæºç æ·±åº¦è§£æ</a>
              </li>
              
              <li class="posts-sidebar-item">
                <a href="/static/posts/ThreadLocalå¼‚æ­¥åœºæ™¯é—®é¢˜è§£æ/" class="posts-sidebar-link active">ThreadLocalå¼‚æ­¥åœºæ™¯é—®é¢˜è§£æ</a>
              </li>
              
              <li class="posts-sidebar-item">
                <a href="/static/posts/Spring-IOCä¸AOPè¯¦è§£/" class="posts-sidebar-link">Spring IOCä¸AOPè¯¦è§£</a>
              </li>
              
              <li class="posts-sidebar-item">
                <a href="/static/posts/Springæºç ä¸­çš„è®¾è®¡æ¨¡å¼è¯¦è§£/" class="posts-sidebar-link">Springæºç ä¸­çš„è®¾è®¡æ¨¡å¼è¯¦è§£</a>
              </li>
              
              <li class="posts-sidebar-item">
                <a href="/static/posts/HashMapæºç åˆ†æ/" class="posts-sidebar-link">HashMapæºç åˆ†æ</a>
              </li>
              
              <li class="posts-sidebar-item">
                <a href="/static/posts/javaè¯­æ³•ç³–è¯¦è§£/" class="posts-sidebar-link">javaè¯­æ³•ç³–è¯¦è§£</a>
              </li>
              
              <li class="posts-sidebar-item">
                <a href="/static/posts/Trae-Javaç¯å¢ƒé…ç½®/" class="posts-sidebar-link">Trae-Javaç¯å¢ƒé…ç½®</a>
              </li>
              
              <li class="posts-sidebar-item">
                <a href="/static/posts/æ¬¢è¿æ¥åˆ°æˆ‘çš„åšå®¢/" class="posts-sidebar-link">æ¬¢è¿æ¥åˆ°æˆ‘çš„åšå®¢</a>
              </li>
              
              <li class="posts-sidebar-item">
                <a href="/static/posts/ä¸ºä»€ä¹ˆJavaä¸­åªæœ‰å€¼ä¼ é€’/" class="posts-sidebar-link">ä¸ºä»€ä¹ˆJavaä¸­åªæœ‰å€¼ä¼ é€’ï¼Ÿ</a>
              </li>
              
              <li class="posts-sidebar-item">
                <a href="/static/posts/å…³äºæŠ€æœ¯åˆ†äº«/" class="posts-sidebar-link">å…³äºæŠ€æœ¯åˆ†äº«</a>
              </li>
              
              <li class="posts-sidebar-item">
                <a href="/static/posts/ä»£ç ä¹‹ç¾/" class="posts-sidebar-link">ä»£ç ä¹‹ç¾</a>
              </li>
              
              <li class="posts-sidebar-item">
                <a href="/static/posts/é¦–é¡µç¾åŒ–æ•™ç¨‹/" class="posts-sidebar-link">é¦–é¡µç¾åŒ–æ•™ç¨‹</a>
              </li>
              
              <li class="posts-sidebar-item">
                <a href="/static/posts/å¦‚ä½•åˆ›å»ºGitHubä¸ªäººç½‘ç«™/" class="posts-sidebar-link">å¦‚ä½•åˆ›å»ºGitHubä¸ªäººç½‘ç«™</a>
              </li>
              
            </ul>
          </nav>
        </aside>

        <article class="post">
          <div class="post-header">
            <a href="/" class="back-link">â† è¿”å›é¦–é¡µ</a>
            <h1 class="post-title">ThreadLocalå¼‚æ­¥åœºæ™¯é—®é¢˜è§£æ</h1>
            <div class="post-meta">
              <span class="post-date">2026å¹´2æœˆ11æ—¥</span>
              <span class="post-views" id="postViews">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                <span>åŠ è½½ä¸­...</span>
              </span>
              
            </div>
          </div>

          <div class="post-content">
            <h1>ThreadLocal å¼‚æ­¥åœºæ™¯é—®é¢˜è§£æ</h1>
<h2 id="é—®é¢˜å¼•å…¥">é—®é¢˜å¼•å…¥</h2>
<p><strong>é¢è¯•å®˜é—®ï¼šThreadLocal åœ¨å¼‚æ­¥åœºæ™¯ä¸‹æœ‰é—®é¢˜å—ï¼Ÿ</strong></p>
<p>è¿™æ˜¯ä¸€ä¸ªéå¸¸ç»å…¸çš„å¹¶å‘ç¼–ç¨‹é¢è¯•é¢˜ï¼Œè€ƒå¯Ÿå€™é€‰äººå¯¹ ThreadLocal åŸç†çš„ç†è§£ï¼Œä»¥åŠåœ¨å¼‚æ­¥åœºæ™¯ä¸‹çš„ä½¿ç”¨ç»éªŒã€‚</p>
<h2 id="ä¸€-ThreadLocal-åœ¨å¼‚æ­¥åœºæ™¯ä¸‹ä¼šå¤±æ•ˆå—">ä¸€ã€ThreadLocal åœ¨å¼‚æ­¥åœºæ™¯ä¸‹ä¼šå¤±æ•ˆå—ï¼Ÿ</h2>
<p><strong>ç­”æ¡ˆï¼šæ˜¯çš„ï¼ŒThreadLocal åœ¨å¼‚æ­¥åœºæ™¯ä¸‹ä¼šå¤±æ•ˆã€‚</strong></p>
<h3 id="1-1-å¤±æ•ˆåŸå› ">1.1 å¤±æ•ˆåŸå› </h3>
<p>ThreadLocal çš„å€¼é»˜è®¤æ˜¯æ— æ³•è·¨çº¿ç¨‹ä¼ é€’çš„ï¼ŒåŸå› å¦‚ä¸‹ï¼š</p>
<pre class="language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Thread</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>
    <span class="token class-name">ThreadLocal<span class="token punctuation">.</span>ThreadLocalMap</span> threadLocals <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token class-name">ThreadLocal<span class="token punctuation">.</span>ThreadLocalMap</span> inheritableThreadLocals <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>ä» Thread ç±»çš„æºç å¯ä»¥çœ‹å‡ºï¼Œæ¯ä¸ª Thread å¯¹è±¡éƒ½æœ‰è‡ªå·±ç‹¬ç«‹çš„ <code>ThreadLocalMap</code>ã€‚ThreadLocal çš„å€¼å°±å­˜å‚¨åœ¨è¿™ä¸ª Map ä¸­ï¼Œkey æ˜¯ ThreadLocal å¯¹è±¡æœ¬èº«ï¼Œvalue æ˜¯å­˜å‚¨çš„æ•°æ®ã€‚</p>
<p><strong>æ ¸å¿ƒé—®é¢˜ï¼š</strong></p>
<ul>
<li>çˆ¶çº¿ç¨‹å’Œå­çº¿ç¨‹æ˜¯ä¸¤ä¸ªä¸åŒçš„ Thread å¯¹è±¡</li>
<li>å®ƒä»¬å„è‡ªæ‹¥æœ‰ç‹¬ç«‹çš„ ThreadLocalMap</li>
<li>å› æ­¤çˆ¶çº¿ç¨‹ä¸­çš„ ThreadLocal å€¼æ— æ³•è‡ªåŠ¨ä¼ é€’ç»™å­çº¿ç¨‹</li>
</ul>
<h3 id="1-2-ä»£ç ç¤ºä¾‹">1.2 ä»£ç ç¤ºä¾‹</h3>
<pre class="language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadLocalDemo</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> threadLocal <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        threadLocal<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"ä¸»çº¿ç¨‹çš„å€¼"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"å­çº¿ç¨‹è·å–åˆ°çš„å€¼: "</span> <span class="token operator">+</span> threadLocal<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"ä¸»çº¿ç¨‹çš„å€¼: "</span> <span class="token operator">+</span> threadLocal<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p><strong>è¾“å‡ºç»“æœï¼š</strong></p>
<pre class="language-plaintext"><code class="language-plaintext">ä¸»çº¿ç¨‹çš„å€¼: ä¸»çº¿ç¨‹çš„å€¼
å­çº¿ç¨‹è·å–åˆ°çš„å€¼: null
</code></pre>
<p>å¯ä»¥çœ‹åˆ°ï¼Œå­çº¿ç¨‹ä¸­è·å–åˆ°çš„æ˜¯ <code>null</code>ï¼Œè¯´æ˜ ThreadLocal çš„å€¼æ²¡æœ‰ä¼ é€’åˆ°å­çº¿ç¨‹ã€‚</p>
<h2 id="äºŒ-å¦‚ä½•è·¨çº¿ç¨‹ä¼ é€’-ThreadLocal-çš„å€¼">äºŒã€å¦‚ä½•è·¨çº¿ç¨‹ä¼ é€’ ThreadLocal çš„å€¼ï¼Ÿ</h2>
<p>é’ˆå¯¹è¿™ä¸ªé—®é¢˜ï¼Œä¸»è¦æœ‰ä¸¤ç§è§£å†³æ–¹æ¡ˆï¼š</p>
<h3 id="2-1-æ–¹æ¡ˆä¸€-JDK-çš„-InheritableThreadLocal">2.1 æ–¹æ¡ˆä¸€ï¼šJDK çš„ InheritableThreadLocal</h3>
<p>InheritableThreadLocal æ˜¯ JDK æä¾›çš„ä¸€ç§ç‰¹æ®Š ThreadLocalï¼Œå¯ä»¥åœ¨åˆ›å»ºå­çº¿ç¨‹æ—¶å°†çˆ¶çº¿ç¨‹çš„å€¼å¤åˆ¶ç»™å­çº¿ç¨‹ã€‚</p>
<h4 id="2.1.1-ä½¿ç”¨ç¤ºä¾‹" tabindex="-1">2.1.1 ä½¿ç”¨ç¤ºä¾‹</h4>
<pre class="language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">InheritableThreadLocalDemo</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">InheritableThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> inheritableThreadLocal <span class="token operator">=</span> 
        <span class="token keyword">new</span> <span class="token class-name">InheritableThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        inheritableThreadLocal<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"ä¸»çº¿ç¨‹çš„å€¼"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"å­çº¿ç¨‹è·å–åˆ°çš„å€¼: "</span> <span class="token operator">+</span> inheritableThreadLocal<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"ä¸»çº¿ç¨‹çš„å€¼: "</span> <span class="token operator">+</span> inheritableThreadLocal<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p><strong>è¾“å‡ºç»“æœï¼š</strong></p>
<pre class="language-plaintext"><code class="language-plaintext">ä¸»çº¿ç¨‹çš„å€¼: ä¸»çº¿ç¨‹çš„å€¼
å­çº¿ç¨‹è·å–åˆ°çš„å€¼: ä¸»çº¿ç¨‹çš„å€¼
</code></pre>
<h4 id="2.1.2-åŸç†åˆ†æ" tabindex="-1">2.1.2 åŸç†åˆ†æ</h4>
<p>InheritableThreadLocal ç»§æ‰¿è‡ª ThreadLocalï¼Œé‡å†™äº†ä¸‰ä¸ªæ ¸å¿ƒæ–¹æ³•ï¼š</p>
<pre class="language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">InheritableThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token keyword">extends</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token punctuation">{</span>
    
    <span class="token keyword">protected</span> <span class="token class-name">T</span> <span class="token function">childValue</span><span class="token punctuation">(</span><span class="token class-name">T</span> parentValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> parentValue<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">ThreadLocalMap</span> <span class="token function">getMap</span><span class="token punctuation">(</span><span class="token class-name">Thread</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> t<span class="token punctuation">.</span>inheritableThreadLocals<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">void</span> <span class="token function">createMap</span><span class="token punctuation">(</span><span class="token class-name">Thread</span> t<span class="token punctuation">,</span> <span class="token class-name">T</span> firstValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        t<span class="token punctuation">.</span>inheritableThreadLocals <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocalMap</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> firstValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p><strong>æ ¸å¿ƒæœºåˆ¶ï¼š</strong></p>
<ol>
<li>Thread ç±»ä¸­æœ‰ä¸¤ä¸ª ThreadLocalMapï¼š<code>threadLocals</code> å’Œ <code>inheritableThreadLocals</code></li>
<li>InheritableThreadLocal ä½¿ç”¨ <code>inheritableThreadLocals</code> æ¥å­˜å‚¨å€¼</li>
<li>å½“åˆ›å»ºå­çº¿ç¨‹æ—¶ï¼ŒThread çš„æ„é€ æ–¹æ³•ä¼šè°ƒç”¨ <code>Thread.init()</code> æ–¹æ³•ï¼š<pre class="language-java"><code class="language-java"><span class="token keyword">if</span> <span class="token punctuation">(</span>parent<span class="token punctuation">.</span>inheritableThreadLocals <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>inheritableThreadLocals <span class="token operator">=</span> 
        <span class="token class-name">ThreadLocal</span><span class="token punctuation">.</span><span class="token function">createInheritedMap</span><span class="token punctuation">(</span>parent<span class="token punctuation">.</span>inheritableThreadLocals<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
</li>
</ol>
<h4 id="2.1.3-çº¿ç¨‹æ± åœºæ™¯ä¸‹çš„é—®é¢˜" tabindex="-1">2.1.3 çº¿ç¨‹æ± åœºæ™¯ä¸‹çš„é—®é¢˜</h4>
<p>InheritableThreadLocal åœ¨çº¿ç¨‹æ± åœºæ™¯ä¸‹ä¼šå¤±æ•ˆï¼ŒåŸå› å¦‚ä¸‹ï¼š</p>
<pre class="language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">InheritableThreadLocalPoolDemo</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">InheritableThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> inheritableThreadLocal <span class="token operator">=</span> 
        <span class="token keyword">new</span> <span class="token class-name">InheritableThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ExecutorService</span> executor <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            inheritableThreadLocal<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"ä»»åŠ¡-"</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            executor<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"çº¿ç¨‹å: "</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> 
                                 <span class="token string">", è·å–åˆ°çš„å€¼: "</span> <span class="token operator">+</span> inheritableThreadLocal<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p><strong>å¯èƒ½è¾“å‡ºï¼š</strong></p>
<pre class="language-plaintext"><code class="language-plaintext">çº¿ç¨‹å: pool-1-thread-1, è·å–åˆ°çš„å€¼: ä»»åŠ¡-0
çº¿ç¨‹å: pool-1-thread-1, è·å–åˆ°çš„å€¼: ä»»åŠ¡-0
çº¿ç¨‹å: pool-1-thread-1, è·å–åˆ°çš„å€¼: ä»»åŠ¡-0
</code></pre>
<p><strong>é—®é¢˜åˆ†æï¼š</strong></p>
<ul>
<li>çº¿ç¨‹æ± ä¼šå¤ç”¨çº¿ç¨‹ï¼Œä¸ä¼šæ¯æ¬¡éƒ½åˆ›å»ºæ–°çº¿ç¨‹</li>
<li>InheritableThreadLocal åªåœ¨çº¿ç¨‹åˆ›å»ºæ—¶å¤åˆ¶ä¸€æ¬¡å€¼</li>
<li>åç»­å¤ç”¨çº¿ç¨‹æ—¶ï¼Œä»ç„¶ä½¿ç”¨çš„æ˜¯ç¬¬ä¸€æ¬¡å¤åˆ¶è¿‡æ¥çš„å€¼</li>
<li>è¿™ä¼šå¯¼è‡´çº¿ç¨‹æ‹¿åˆ°çš„å¯èƒ½æ˜¯ä¸Šä¸€ä¸ªä»»åŠ¡ä¼ ä¸‹æ¥çš„è„æ•°æ®</li>
</ul>
<h3 id="2-2-æ–¹æ¡ˆäºŒ-é˜¿é‡Œçš„-TransmittableThreadLocal-TTL">2.2 æ–¹æ¡ˆäºŒï¼šé˜¿é‡Œçš„ TransmittableThreadLocal (TTL)</h3>
<p>TransmittableThreadLocal æ˜¯é˜¿é‡Œå¼€æºçš„ TTL åº“æä¾›çš„è§£å†³æ–¹æ¡ˆï¼Œä¸“é—¨è§£å†³çº¿ç¨‹æ± åœºæ™¯ä¸‹ ThreadLocal çš„ä¼ é€’é—®é¢˜ã€‚</p>
<h4 id="2.2.1-ä½¿ç”¨ç¤ºä¾‹" tabindex="-1">2.2.1 ä½¿ç”¨ç¤ºä¾‹</h4>
<pre class="language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TransmittableThreadLocalDemo</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">TransmittableThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> transmittableThreadLocal <span class="token operator">=</span> 
        <span class="token keyword">new</span> <span class="token class-name">TransmittableThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ExecutorService</span> executor <span class="token operator">=</span> <span class="token class-name">TtlExecutors</span><span class="token punctuation">.</span><span class="token function">getTtlExecutorService</span><span class="token punctuation">(</span>
        <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            transmittableThreadLocal<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"ä»»åŠ¡-"</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            executor<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"çº¿ç¨‹å: "</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> 
                                 <span class="token string">", è·å–åˆ°çš„å€¼: "</span> <span class="token operator">+</span> transmittableThreadLocal<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p><strong>è¾“å‡ºç»“æœï¼š</strong></p>
<pre class="language-plaintext"><code class="language-plaintext">çº¿ç¨‹å: pool-1-thread-1, è·å–åˆ°çš„å€¼: ä»»åŠ¡-0
çº¿ç¨‹å: pool-1-thread-1, è·å–åˆ°çš„å€¼: ä»»åŠ¡-1
çº¿ç¨‹å: pool-1-thread-1, è·å–åˆ°çš„å€¼: ä»»åŠ¡-2
</code></pre>
<p>å¯ä»¥çœ‹åˆ°ï¼Œå³ä½¿çº¿ç¨‹æ± å¤ç”¨çº¿ç¨‹ï¼Œæ¯ä¸ªä»»åŠ¡éƒ½èƒ½è·å–åˆ°æ­£ç¡®çš„å€¼ã€‚</p>
<h4 id="2.2.2-åŸç†åˆ†æ" tabindex="-1">2.2.2 åŸç†åˆ†æ</h4>
<p>TransmittableThreadLocal çš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼š<strong>å°† ThreadLocal çš„å€¼ä¸ä»»åŠ¡ç»‘å®šï¼Œè€Œä¸æ˜¯ä¸çº¿ç¨‹ç»‘å®šã€‚</strong></p>
<p><strong>å·¥ä½œæµç¨‹ï¼š</strong></p>
<ol>
<li>
<p><strong>æ•è·é˜¶æ®µï¼š</strong> åœ¨æäº¤ä»»åŠ¡åˆ°çº¿ç¨‹æ± æ—¶ï¼Œæ•è·çˆ¶çº¿ç¨‹çš„ ThreadLocal å€¼</p>
<pre class="language-java"><code class="language-java"><span class="token comment">// TtlRunnable æºç ç®€åŒ–</span>
<span class="token keyword">public</span> <span class="token class-name">TtlRunnable</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> runnable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>captured <span class="token operator">=</span> <span class="token class-name">TransmittableThreadLocal<span class="token punctuation">.</span>Transmitter</span><span class="token punctuation">.</span><span class="token function">capture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>runnable <span class="token operator">=</span> runnable<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
</li>
<li>
<p><strong>æ¢å¤é˜¶æ®µï¼š</strong> ä»»åŠ¡æ‰§è¡Œå‰ï¼Œå°†æ•è·çš„å€¼è®¾ç½®åˆ°å½“å‰çº¿ç¨‹</p>
<pre class="language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Object</span> backup <span class="token operator">=</span> <span class="token class-name">TransmittableThreadLocal<span class="token punctuation">.</span>Transmitter</span><span class="token punctuation">.</span><span class="token function">replay</span><span class="token punctuation">(</span>captured<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        runnable<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token class-name">TransmittableThreadLocal<span class="token punctuation">.</span>Transmitter</span><span class="token punctuation">.</span><span class="token function">restore</span><span class="token punctuation">(</span>backup<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
</li>
<li>
<p><strong>æ¸…ç†é˜¶æ®µï¼š</strong> ä»»åŠ¡æ‰§è¡Œå®Œæˆåï¼Œæ¢å¤çº¿ç¨‹åŸæ¥çš„å€¼</p>
</li>
</ol>
<p><strong>æ ¸å¿ƒæœºåˆ¶å¯¹æ¯”ï¼š</strong></p>
<table>
<thead>
<tr>
<th>ç‰¹æ€§</th>
<th>InheritableThreadLocal</th>
<th>TransmittableThreadLocal</th>
</tr>
</thead>
<tbody>
<tr>
<td>ç»‘å®šå¯¹è±¡</td>
<td>çº¿ç¨‹</td>
<td>ä»»åŠ¡</td>
</tr>
<tr>
<td>å¤åˆ¶æ—¶æœº</td>
<td>çº¿ç¨‹åˆ›å»ºæ—¶</td>
<td>ä»»åŠ¡æäº¤æ—¶</td>
</tr>
<tr>
<td>çº¿ç¨‹æ± æ”¯æŒ</td>
<td>ä¸æ”¯æŒ</td>
<td>æ”¯æŒ</td>
</tr>
<tr>
<td>é€‚ç”¨åœºæ™¯</td>
<td>ç®€å•çˆ¶å­çº¿ç¨‹</td>
<td>çº¿ç¨‹æ± ã€å¼‚æ­¥åœºæ™¯</td>
</tr>
</tbody>
</table>
<h2 id="ä¸‰-é¢è¯•å›ç­”æ€»ç»“">ä¸‰ã€é¢è¯•å›ç­”æ€»ç»“</h2>
<p><strong>é¢è¯•å®˜ï¼šThreadLocal å¼‚æ­¥åœºæ™¯æœ‰é—®é¢˜å—ï¼Ÿ</strong></p>
<p><strong>å®Œæ•´å›ç­”ï¼š</strong></p>
<blockquote>
<p>ThreadLocal åœ¨å¼‚æ­¥åœºæ™¯ä¸‹ç¡®å®ä¼šæœ‰é—®é¢˜ã€‚å®ƒçš„å€¼å­˜å‚¨åœ¨æ¯ä¸ªçº¿ç¨‹ç‹¬ç«‹çš„ ThreadLocalMap ä¸­ï¼Œçˆ¶å­çº¿ç¨‹æ˜¯ä¸¤ä¸ªä¸åŒçš„å¯¹è±¡ï¼Œå› æ­¤å€¼æ— æ³•è‡ªåŠ¨ä¼ é€’ã€‚</p>
<p>è§£å†³æ–¹æ¡ˆä¸»è¦æœ‰ä¸¤ç§ï¼š</p>
<ol>
<li>
<p><strong>InheritableThreadLocal</strong>ï¼šJDK æä¾›çš„æ–¹æ¡ˆï¼Œåœ¨åˆ›å»ºå­çº¿ç¨‹æ—¶å°†çˆ¶çº¿ç¨‹çš„å€¼å¤åˆ¶ç»™å­çº¿ç¨‹ã€‚ä½†å®ƒåœ¨çº¿ç¨‹æ± åœºæ™¯ä¸‹ä¼šå¤±æ•ˆï¼Œå› ä¸ºçº¿ç¨‹æ± ä¼šå¤ç”¨çº¿ç¨‹ï¼Œå¯¼è‡´çº¿ç¨‹æ‹¿åˆ°çš„å¯èƒ½æ˜¯è„æ•°æ®ã€‚</p>
</li>
<li>
<p><strong>TransmittableThreadLocal</strong>ï¼šé˜¿é‡Œå¼€æºçš„ TTL åº“æä¾›çš„æ–¹æ¡ˆã€‚å®ƒçš„åŸç†æ˜¯åœ¨æäº¤ä»»åŠ¡åˆ°çº¿ç¨‹æ± æ—¶ï¼ŒæŠŠçˆ¶çº¿ç¨‹çš„ ThreadLocal å€¼æ•è·ä¸‹æ¥ï¼Œå’Œä»»åŠ¡ç»‘å®šåœ¨ä¸€èµ·ã€‚ç­‰çº¿ç¨‹æ± é‡Œçš„æŸä¸ªçº¿ç¨‹è¦æ‰§è¡Œè¿™ä¸ªä»»åŠ¡æ—¶ï¼Œå†æŠŠæ•è·çš„å€¼è®¾ç½®åˆ°è¿™ä¸ªçº¿ç¨‹ä¸Šï¼Œä»»åŠ¡æ‰§è¡Œå®Œå†æ¸…ç†æ‰ã€‚</p>
</li>
</ol>
<p>ç®€å•è¯´ï¼ŒInheritableThreadLocal æ˜¯è·Ÿçº¿ç¨‹ç»‘å®šçš„ï¼Œåªåœ¨åˆ›å»ºæ—¶æœ‰æ•ˆï¼›è€Œ TTL æ˜¯è·Ÿä»»åŠ¡ç»‘å®šçš„ï¼Œå®Œç¾æ”¯æŒçº¿ç¨‹æ± ã€‚</p>
</blockquote>
<h2 id="å››-å®é™…åº”ç”¨åœºæ™¯">å››ã€å®é™…åº”ç”¨åœºæ™¯</h2>
<h3 id="4-1-åˆ†å¸ƒå¼è¿½è¸ª">4.1 åˆ†å¸ƒå¼è¿½è¸ª</h3>
<pre class="language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TraceContext</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">TransmittableThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> traceId <span class="token operator">=</span> 
        <span class="token keyword">new</span> <span class="token class-name">TransmittableThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">setTraceId</span><span class="token punctuation">(</span><span class="token class-name">String</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        traceId<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getTraceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> traceId<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        traceId<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="4-2-ç”¨æˆ·ä¸Šä¸‹æ–‡ä¼ é€’">4.2 ç”¨æˆ·ä¸Šä¸‹æ–‡ä¼ é€’</h3>
<pre class="language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserContext</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">TransmittableThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">></span></span> currentUser <span class="token operator">=</span> 
        <span class="token keyword">new</span> <span class="token class-name">TransmittableThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">setCurrentUser</span><span class="token punctuation">(</span><span class="token class-name">User</span> user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        currentUser<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">User</span> <span class="token function">getCurrentUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> currentUser<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="4-3-æ•°æ®åº“åŠ¨æ€æ•°æ®æºåˆ‡æ¢">4.3 æ•°æ®åº“åŠ¨æ€æ•°æ®æºåˆ‡æ¢</h3>
<pre class="language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DataSourceContextHolder</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">TransmittableThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> dataSourceKey <span class="token operator">=</span> 
        <span class="token keyword">new</span> <span class="token class-name">TransmittableThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">setDataSourceKey</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        dataSourceKey<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getDataSourceKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> dataSourceKey<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">clearDataSourceKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        dataSourceKey<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="äº”-æ³¨æ„äº‹é¡¹">äº”ã€æ³¨æ„äº‹é¡¹</h2>
<ol>
<li><strong>å†…å­˜æ³„æ¼é£é™©</strong>ï¼šä½¿ç”¨ ThreadLocal åä¸€å®šè¦è°ƒç”¨ <code>remove()</code> æ–¹æ³•æ¸…ç†ï¼Œå¦åˆ™å¯èƒ½å¯¼è‡´å†…å­˜æ³„æ¼</li>
<li><strong>TTL è£…é¥°å™¨</strong>ï¼šä½¿ç”¨ TTL æ—¶ï¼Œéœ€è¦ç”¨ <code>TtlExecutors</code>ã€<code>TtlForkJoinPool</code> ç­‰è£…é¥°å™¨åŒ…è£…çº¿ç¨‹æ± </li>
<li><strong>æ€§èƒ½è€ƒè™‘</strong>ï¼šTTL çš„æ•è·å’Œæ¢å¤æœºåˆ¶ä¼šå¸¦æ¥ä¸€å®šçš„æ€§èƒ½å¼€é”€ï¼Œåœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹éœ€è¦æ³¨æ„</li>
<li><strong>å€¼ä¸å¯å˜</strong>ï¼šThreadLocal ä¸­å­˜å‚¨çš„å¯¹è±¡æœ€å¥½æ˜¯ä¸å¯å˜çš„ï¼Œé¿å…å¤šçº¿ç¨‹ä¿®æ”¹å¸¦æ¥çš„é—®é¢˜</li>
</ol>
<h2 id="å…­-æ€»ç»“">å…­ã€æ€»ç»“</h2>
<table>
<thead>
<tr>
<th>æ–¹æ¡ˆ</th>
<th>é€‚ç”¨åœºæ™¯</th>
<th>ä¼˜ç‚¹</th>
<th>ç¼ºç‚¹</th>
</tr>
</thead>
<tbody>
<tr>
<td>ThreadLocal</td>
<td>å•çº¿ç¨‹</td>
<td>ç®€å•é«˜æ•ˆ</td>
<td>æ— æ³•è·¨çº¿ç¨‹</td>
</tr>
<tr>
<td>InheritableThreadLocal</td>
<td>ç®€å•çˆ¶å­çº¿ç¨‹</td>
<td>JDK åŸç”Ÿæ”¯æŒ</td>
<td>çº¿ç¨‹æ± å¤±æ•ˆ</td>
</tr>
<tr>
<td>TransmittableThreadLocal</td>
<td>çº¿ç¨‹æ± ã€å¼‚æ­¥</td>
<td>å®Œç¾æ”¯æŒçº¿ç¨‹æ± </td>
<td>éœ€è¦å¼•å…¥ä¾èµ–</td>
</tr>
</tbody>
</table>
<p>åœ¨å®é™…é¡¹ç›®ä¸­ï¼Œæ¨èä½¿ç”¨ TransmittableThreadLocalï¼Œå› ä¸ºå®ƒèƒ½å¤Ÿå®Œç¾è§£å†³çº¿ç¨‹æ± åœºæ™¯ä¸‹ ThreadLocal ä¼ é€’çš„é—®é¢˜ã€‚</p>

          </div>

          <section class="share-section">
            <h3 class="share-title">åˆ†äº«è¿™ç¯‡æ–‡ç« </h3>
            <div class="share-buttons">
              <button class="share-button share-twitter" data-platform="twitter" aria-label="åˆ†äº«åˆ° Twitter">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"></path></svg>
                <span>Twitter</span>
              </button>
              <button class="share-button share-weibo" data-platform="weibo" aria-label="åˆ†äº«åˆ°å¾®åš">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M10.5 2C6.357 2 3 5.357 3 9.5c0 2.45 1.197 4.627 3.046 5.964-.042.533-.053 1.1.05 1.732.378 2.327 2.48 4.304 5.204 4.304 3.037 0 5.5-2.463 5.5-5.5 0-2.043-1.118-3.827-2.78-4.777.19-.615.3-1.268.3-1.948 0-3.643-2.857-6.5-6.5-6.5zm0 1.5c2.485 0 4.5 2.015 4.5 4.5 0 .405-.065.795-.18 1.167-.55-.125-1.125-.192-1.715-.192-3.59 0-6.5 2.91-6.5 6.5 0 .59.067 1.165.192 1.715-1.247-1.057-2.042-2.635-2.042-4.392 0-3.037 2.463-5.5 5.5-5.5 2.485 0 4.5 2.015 4.5 4.5 0 2.485-2.015 4.5-4.5 4.5-2.485 0-4.5-2.015-4.5-4.5 0-2.485 2.015-4.5 4.5-4.5zm5.5 7c.552 0 1 .448 1 1s-.448 1-1 1-1-.448-1-1 .448-1 1-1z"></path></svg>
                <span>å¾®åš</span>
              </button>
              <button class="share-button share-link" data-platform="link" aria-label="å¤åˆ¶é“¾æ¥">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg>
                <span>å¤åˆ¶é“¾æ¥</span>
              </button>
            </div>
            <div class="share-toast" id="shareToast">é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿</div>
          </section>

          
          <section class="comments-section">
            <div class="comments-container">
              <h3 class="comments-title">è¯„è®ºåŒº</h3>
              <div class="giscus-wrapper">
                <script src="https://giscus.app/client.js"
                  data-repo="zhizhi2213/zhizhi2213.github.io"
                  data-repo-id="R_kgDOQ-4OZg"
                  data-category="Announcements"
                  data-category-id="DIC_kwDOQ-4OZs4C2RLo"
                  data-mapping="pathname"
                  data-strict="0"
                  data-reactions-enabled="1"
                  data-emit-metadata="0"
                  data-input-position="bottom"
                  data-theme="preferred_color_scheme"
                  data-lang="zh-CN"
                  data-loading="lazy"
                  crossorigin="anonymous"
                  async>
                </script>
              </div>
            </div>
          </section>
          

          <aside class="related-posts">
            <h3 class="related-posts-title">ç›¸å…³æ–‡ç« </h3>
            <ul class="related-posts-list">
              
              <li class="related-posts-item">
                <a href="/static/posts/MyBatisæºç æ·±åº¦è§£æ/" class="related-posts-link">
                  <h4 class="related-posts-item-title">MyBatisæºç æ·±åº¦è§£æ</h4>
                  <time class="related-posts-item-date">2026å¹´2æœˆ11æ—¥</time>
                </a>
              </li>
              
              <li class="related-posts-item">
                <a href="/static/posts/Spring-IOCä¸AOPè¯¦è§£/" class="related-posts-link">
                  <h4 class="related-posts-item-title">Spring IOCä¸AOPè¯¦è§£</h4>
                  <time class="related-posts-item-date">2026å¹´2æœˆ10æ—¥</time>
                </a>
              </li>
              
              <li class="related-posts-item">
                <a href="/static/posts/Springæºç ä¸­çš„è®¾è®¡æ¨¡å¼è¯¦è§£/" class="related-posts-link">
                  <h4 class="related-posts-item-title">Springæºç ä¸­çš„è®¾è®¡æ¨¡å¼è¯¦è§£</h4>
                  <time class="related-posts-item-date">2026å¹´2æœˆ9æ—¥</time>
                </a>
              </li>
              
            </ul>
          </aside>
        </article>

        
        <aside class="toc-container">
          <nav class="toc-content" id="tocContent">
            <a href="#é—®é¢˜å¼•å…¥" class="toc-item toc-level-2" style="">é—®é¢˜å¼•å…¥</a><a href="#ä¸€-ThreadLocal-åœ¨å¼‚æ­¥åœºæ™¯ä¸‹ä¼šå¤±æ•ˆå—" class="toc-item toc-level-2" style="">ä¸€ã€ThreadLocal åœ¨å¼‚æ­¥åœºæ™¯ä¸‹ä¼šå¤±æ•ˆå—ï¼Ÿ</a><a href="#1-1-å¤±æ•ˆåŸå› " class="toc-item toc-level-3" style="padding-left: 1.5rem;">1.1 å¤±æ•ˆåŸå› </a><a href="#1-2-ä»£ç ç¤ºä¾‹" class="toc-item toc-level-3" style="padding-left: 1.5rem;">1.2 ä»£ç ç¤ºä¾‹</a><a href="#äºŒ-å¦‚ä½•è·¨çº¿ç¨‹ä¼ é€’-ThreadLocal-çš„å€¼" class="toc-item toc-level-2" style="">äºŒã€å¦‚ä½•è·¨çº¿ç¨‹ä¼ é€’ ThreadLocal çš„å€¼ï¼Ÿ</a><a href="#2-1-æ–¹æ¡ˆä¸€-JDK-çš„-InheritableThreadLocal" class="toc-item toc-level-3" style="padding-left: 1.5rem;">2.1 æ–¹æ¡ˆä¸€ï¼šJDK çš„ InheritableThreadLocal</a><a href="#2-2-æ–¹æ¡ˆäºŒ-é˜¿é‡Œçš„-TransmittableThreadLocal-TTL" class="toc-item toc-level-3" style="padding-left: 1.5rem;">2.2 æ–¹æ¡ˆäºŒï¼šé˜¿é‡Œçš„ TransmittableThreadLocal (TTL)</a><a href="#ä¸‰-é¢è¯•å›ç­”æ€»ç»“" class="toc-item toc-level-2" style="">ä¸‰ã€é¢è¯•å›ç­”æ€»ç»“</a><a href="#å››-å®é™…åº”ç”¨åœºæ™¯" class="toc-item toc-level-2" style="">å››ã€å®é™…åº”ç”¨åœºæ™¯</a><a href="#4-1-åˆ†å¸ƒå¼è¿½è¸ª" class="toc-item toc-level-3" style="padding-left: 1.5rem;">4.1 åˆ†å¸ƒå¼è¿½è¸ª</a><a href="#4-2-ç”¨æˆ·ä¸Šä¸‹æ–‡ä¼ é€’" class="toc-item toc-level-3" style="padding-left: 1.5rem;">4.2 ç”¨æˆ·ä¸Šä¸‹æ–‡ä¼ é€’</a><a href="#4-3-æ•°æ®åº“åŠ¨æ€æ•°æ®æºåˆ‡æ¢" class="toc-item toc-level-3" style="padding-left: 1.5rem;">4.3 æ•°æ®åº“åŠ¨æ€æ•°æ®æºåˆ‡æ¢</a><a href="#äº”-æ³¨æ„äº‹é¡¹" class="toc-item toc-level-2" style="">äº”ã€æ³¨æ„äº‹é¡¹</a><a href="#å…­-æ€»ç»“" class="toc-item toc-level-2" style="">å…­ã€æ€»ç»“</a>
          </nav>
        </aside>
        
      </div>
    </div>
  </main>

  <footer class="footer">
    <div class="container">
      <p>&copy; 2026 zhizhi2213. All rights reserved.</p>
      <p class="footer-links">
        <a href="/atom.xml" aria-label="RSS è®¢é˜…">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg>
          RSS è®¢é˜…
        </a>
      </p>
    </div>
  </footer>

  <button class="back-to-top" id="backToTop" aria-label="è¿”å›é¡¶éƒ¨">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="18 15 12 9 6 15"></polyline></svg>
  </button>

  <button class="reading-mode-toggle" id="readingModeToggle" aria-label="é˜…è¯»æ¨¡å¼" title="åˆ‡æ¢é˜…è¯»æ¨¡å¼">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"></path><circle cx="12" cy="12" r="3"></circle></svg>
  </button>

  <script src="/static/assets/script.js" defer></script>
</body>
</html>
